# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –Æ–ö–∞—Å—Å–∞

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å –Æ–ö–∞—Å—Å–∞ (YooKassa) ‚Äî –Ω–∞–¥—ë–∂–Ω—ã–º –ø–ª–∞—Ç—ë–∂–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º –¥–ª—è –ø—Ä–∏—ë–º–∞ –æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç–µ–∂–µ–π.

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `.env.local` –∏ Vercel –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```env
# YooKassa Payment Gateway
YOOKASSA_SHOP_ID=1175953
YOOKASSA_SECRET_KEY=test__LW2seH_-zNWtCGlSj497zQ6rWi9vwtHJm_fVbkO6Gc

# Site URL (–¥–ª—è redirect –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã)
NEXT_PUBLIC_SITE_URL=https://bez-pauzy.ru
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –í production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ **–±–æ–µ–≤—ã–µ** –∫–ª—é—á–∏ –Æ–ö–∞—Å—Å–∞, –∞ –Ω–µ —Ç–µ—Å—Ç–æ–≤—ã–µ!

### 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é `058_add_subscription_fields.sql` –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:

```bash
# –ß–µ—Ä–µ–∑ Supabase CLI
supabase db push

# –ò–ª–∏ —á–µ—Ä–µ–∑ Supabase Dashboard:
# 1. –û—Ç–∫—Ä–æ–π—Ç–µ SQL Editor
# 2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ supabase/migrations/058_add_subscription_fields.sql
# 3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook –≤ –Æ–ö–∞—Å—Å–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ [–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –Æ–ö–∞—Å—Å–∞](https://yookassa.ru/)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
3. –î–æ–±–∞–≤—å—Ç–µ URL –¥–ª—è webhook:
   ```
   https://bez-pauzy.ru/api/payment/webhook
   ```
4. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:
   - ‚úÖ `payment.succeeded` (—É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç—ë–∂)
   - ‚úÖ `payment.canceled` (–æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–π –ø–ª–∞—Ç—ë–∂)
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –§–∞–π–ª—ã

```
app/
‚îú‚îÄ‚îÄ payment/
‚îÇ   ‚îú‚îÄ‚îÄ subscribe/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                    # –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–¥–ø–∏—Å–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ success/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                    # –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ cancel/
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx                    # –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–º–µ–Ω—ë–Ω–Ω–æ–π –æ–ø–ª–∞—Ç—ã
‚îÇ
‚îî‚îÄ‚îÄ api/
    ‚îî‚îÄ‚îÄ payment/
        ‚îú‚îÄ‚îÄ create-subscription/
        ‚îÇ   ‚îî‚îÄ‚îÄ route.ts                # API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
        ‚îî‚îÄ‚îÄ webhook/
            ‚îî‚îÄ‚îÄ route.ts                # Webhook –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–ù–æ–≤—ã–µ –ø–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ `menohub_users`:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `subscription_status` | TEXT | `inactive`, `active`, `cancelled`, `expired` |
| `subscription_plan` | TEXT | `monthly`, `annual` |
| `payment_status` | TEXT | `unpaid`, `paid`, `refunded` |
| `subscription_end_date` | TIMESTAMPTZ | –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ |
| `last_payment_date` | TIMESTAMPTZ | –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ–ø–ª–∞—Ç—ã |

## üéØ –ü–ª–∞–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏

### –ú–µ—Å—è—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
- **–¶–µ–Ω–∞:** 990‚ÇΩ/–º–µ—Å
- **–°—Ä–æ–∫:** 30 –¥–Ω–µ–π
- **ID:** `monthly`

### –ì–æ–¥–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
- **–¶–µ–Ω–∞:** 7990‚ÇΩ/–≥–æ–¥ (—ç–∫–æ–Ω–æ–º–∏—è 4000‚ÇΩ)
- **–°—Ä–æ–∫:** 365 –¥–Ω–µ–π
- **ID:** `annual`

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã

### 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –ø–ª–∞–Ω

```
/payment/subscribe ‚Üí –í—ã–±–æ—Ä –ø–ª–∞–Ω–∞ ‚Üí –ö–Ω–æ–ø–∫–∞ "–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞

```typescript
POST /api/payment/create-subscription
Body: {
  planId: "monthly" | "annual",
  amount: 990 | 7990
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –°–æ–∑–¥–∞—ë—Ç—Å—è –ø–ª–∞—Ç—ë–∂ –≤ –Æ–ö–∞—Å—Å–∞ API
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `confirmationUrl` –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 3. –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –Æ–ö–∞—Å—Å–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –Æ–ö–∞—Å—Å–∞ (—Ñ–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã) ‚Üí –ë–∞–Ω–∫ ‚Üí –Æ–ö–∞—Å—Å–∞
```

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞:**
```
–Æ–ö–∞—Å—Å–∞ webhook ‚Üí /api/payment/webhook ‚Üí –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ë–î
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /payment/success
```

**–û—Ç–º–µ–Ω—ë–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /payment/cancel
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Webhook Verification

–í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ webhook –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã. –î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É IP-–∞–¥—Ä–µ—Å–æ–≤ –Æ–ö–∞—Å—Å–∞:

```typescript
// –í app/api/payment/webhook/route.ts
const YOOKASSA_IPS = [
  '185.71.76.0/27',
  '185.71.77.0/27',
  '77.75.153.0/25',
  '77.75.156.11',
  '77.75.156.35',
  '77.75.154.128/25',
]

function isYooKassaIP(ip: string): boolean {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ IP –∞–¥—Ä–µ—Å–∞
  return YOOKASSA_IPS.some(range => ipInRange(ip, range))
}
```

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –Æ–ö–∞—Å—Å–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `Idempotence-Key` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π.

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã –Æ–ö–∞—Å—Å–∞

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞—Ä—Ç—ã:

**–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞:**
```
–ù–æ–º–µ—Ä: 5555 5555 5555 4444
–°—Ä–æ–∫: 12/24
CVC: 123
```

**–û—Ç–∫–ª–æ–Ω—ë–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞:**
```
–ù–æ–º–µ—Ä: 5555 5555 5555 5599
–°—Ä–æ–∫: 12/24
CVC: 123
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook –ª–æ–∫–∞–ª—å–Ω–æ

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è webhook:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ ngrok
ngrok http 3000

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ webhook URL –≤ –Æ–ö–∞—Å—Å–∞:
https://your-ngrok-url.ngrok.io/api/payment/webhook
```

## üìù –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –ø–ª–∞—Ç–µ–∂–µ–π

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `[Payment]` –∏–ª–∏ `[Webhook]`:

```typescript
console.log('‚úÖ [Payment] Payment created:', { paymentId, userId, planId })
console.log('‚úÖ [Webhook] Subscription activated:', { userId, subscriptionEnd })
console.error('‚ùå [Payment] Error:', error)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Supabase

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏:

```sql
SELECT 
  id,
  username,
  email,
  subscription_status,
  subscription_plan,
  subscription_end_date,
  is_subscribed
FROM menohub_users
WHERE subscription_status = 'active'
ORDER BY subscription_end_date DESC;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç—ë–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫

```sql
-- –í—Ä—É—á–Ω—É—é –æ–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç—ë–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
SELECT check_expired_subscriptions();

-- –ò–ª–∏ —á–µ—Ä–µ–∑ UPDATE:
UPDATE menohub_users
SET 
  subscription_status = 'expired',
  is_subscribed = false
WHERE 
  subscription_status = 'active'
  AND subscription_end_date < NOW();
```

## üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ (—Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏)
- [ ] Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
- [ ] –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (trial)
- [ ] –ü—Ä–æ–º–æ–∫–æ–¥—ã –∏ —Å–∫–∏–¥–∫–∏
- [ ] –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ —á–µ—Ä–µ–∑ –Æ–ö–∞—Å—Å–∞
- [ ] –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Vercel Dashboard
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –Æ–ö–∞—Å—Å–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Supabase Dashboard
4. –ö–æ–Ω—Ç–∞–∫—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Æ–ö–∞—Å—Å–∞: https://yookassa.ru/support

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2026-01-28
