#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤—Å–µ—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ merge
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é (ours) –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤

set -e

echo "üîß –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –†–ê–ó–†–ï–®–ï–ù–ò–ï –ö–û–ù–§–õ–ò–ö–¢–û–í"
echo "========================================"
echo ""
echo "üìã –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –õ–û–ö–ê–õ–¨–ù–£–Æ –≤–µ—Ä—Å–∏—é –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤"
echo "   (–≤–∞—à–∞ –≤–µ—Ä—Å–∏—è –±–æ–ª–µ–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è)"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å merge (—ç—Ç–æ –≤–∞–∂–Ω–µ–µ, —á–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∞ diff)
MERGE_HEAD=$(git rev-parse -q --verify MERGE_HEAD 2>/dev/null || echo "")
if [ -z "$MERGE_HEAD" ]; then
    echo "‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ merge –ø—Ä–æ—Ü–µ—Å—Å–∞"
    exit 1
fi

echo "üìä –ù–∞–π–¥–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö:"
git diff --name-only --diff-filter=U
echo ""

# –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
CONFLICT_COUNT=$(git diff --name-only --diff-filter=U | wc -l | tr -d ' ')
echo "üìà –í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏: $CONFLICT_COUNT"
echo ""

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
read -p "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –õ–û–ö–ê–õ–¨–ù–£–Æ –≤–µ—Ä—Å–∏—é –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤? (y/n): " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
    exit 1
fi

echo ""
echo "üîÑ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤..."

# –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–º –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é
CONFLICT_FILES=$(git diff --name-only --diff-filter=U)

for file in $CONFLICT_FILES; do
    echo "   ‚úì $file (–ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)"
    git checkout --ours "$file"
    git add "$file"
done

echo ""
echo "‚úÖ –í—Å–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)"
echo ""

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:"
git status --short
echo ""

# –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å merge
read -p "–ó–∞–≤–µ—Ä—à–∏—Ç—å merge? (y/n): " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ö†Ô∏è  Merge –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:"
    echo "   git commit -m 'Merge: Resolved conflicts (used local version)'"
    exit 0
fi

# –ó–∞–≤–µ—Ä—à–∞–µ–º merge
echo ""
echo "üíæ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ merge..."
git commit -m "Merge: Resolved conflicts (used local version)" --no-edit

echo ""
echo "‚úÖ Merge —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo ""
echo "üì§ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ GitHub:"
echo "   git push origin main"
echo ""

