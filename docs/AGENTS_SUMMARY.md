# –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–≥–µ–Ω—Ç–æ–≤

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: –î–í–ê –∞–≥–µ–Ω—Ç–∞ (–∫–∞–∫ –≤ n8n)

### 1. –û—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç (AI Agent) - –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã

**–§–∞–π–ª—ã:**
- `lib/ai/main-agent.ts` - —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞
- `lib/ai/main-agent-tools.ts` - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–≥–µ–Ω—Ç–∞

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- ‚úÖ `Vector_store` - –ø–æ–∏—Å–∫ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π (`menohub_documents`)
- ‚úÖ `Get_user_age` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `Update_city` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:**
- –û–±—ã—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
- –í–æ–ø—Ä–æ—Å—ã –æ —Å–∏–º–ø—Ç–æ–º–∞—Ö, –ª–µ—á–µ–Ω–∏–∏, –∑–¥–æ—Ä–æ–≤—å–µ

### 2. –ê–≥–µ–Ω—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤—Ä–∞—á–µ–π (AI Agent1) - –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤—Ä–∞—á–µ–π

**–§–∞–π–ª—ã:**
- `lib/ai/agent.ts` - —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞
- `lib/ai/agent-tools.ts` - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–≥–µ–Ω—Ç–∞

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- ‚úÖ `search_doctors` - –ø–æ–∏—Å–∫ –≤—Ä–∞—á–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ `menohub_doctors`

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:**
- –ó–∞–ø—Ä–æ—Å—ã "–Ω–∞–π–¥–∏ –≤—Ä–∞—á–∞", "–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç"
- –ü–æ–∏—Å–∫ –∫–ª–∏–Ω–∏–∫
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤—Ä–∞—á–µ–π

## üîÑ –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –∞–≥–µ–Ω—Ç–∞

**–§–∞–π–ª:** `lib/ai/message-processor.ts`

```typescript
// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (Lakera)
// 2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞:
if (isDoctorSearch) {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤—Ä–∞—á–µ–π
  return runAgent(...)
}
// 3. –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç
return runMainAgent(...)
```

## üìä –¢–∞–±–ª–∏—Ü—ã –≤ Supabase

### –î–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞:
- `menohub_documents` - –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (—Å embeddings)
- `menohub_users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (age, age_group, city, telegram_id)

### –î–ª—è –∞–≥–µ–Ω—Ç–∞ –≤—Ä–∞—á–µ–π:
- `menohub_doctors` - –≤—Ä–∞—á–∏ (specialty, city, name, booking_link, rating)

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### 1. –í–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π

–¢–∞–±–ª–∏—Ü–∞ `menohub_documents` –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Å:
- –í–µ–∫—Ç–æ—Ä–Ω—ã–º–∏ embeddings (—á–µ—Ä–µ–∑ pgvector)
- –§—É–Ω–∫—Ü–∏–µ–π `match_menohub_documents` –¥–ª—è –ø–æ–∏—Å–∫–∞
- –ö–æ–ª–æ–Ω–∫–∞–º–∏: `content`, `embedding`, `metadata`

### 2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
OPENAI_API_KEY=sk-...
SUPABASE_SERVICE_ROLE_KEY=... (–¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞)
```

### 3. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
npm install @langchain/openai @langchain/core @langchain/community openai
```

## üìù –û—Ç–ª–∏—á–∏—è –æ—Ç n8n

### –í n8n –±—ã–ª–æ:
- **AI Agent**: Vector_store + Research (Perplexity) + Get_user_age + Update_city
- **AI Agent1**: search_doctors + research

### –°–µ–π—á–∞—Å:
- **–û—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç**: Vector_store + Get_user_age + Update_city
- **–ê–≥–µ–Ω—Ç –≤—Ä–∞—á–µ–π**: search_doctors

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚ùå –£–±—Ä–∞–Ω Research (Perplexity) - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –∏–∑ –ë–î
- ‚úÖ –û–±–∞ –∞–≥–µ–Ω—Ç–∞ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏** - –∫–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç —Ä–µ—à–∞–µ—Ç —Å–≤–æ—é –∑–∞–¥–∞—á—É
2. **–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è** - –∞–≥–µ–Ω—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ —Å–≤–æ–∏ –∑–∞–¥–∞—á–∏
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–π –ë–î
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –±—ã—Å—Ç—Ä–µ–µ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–∏—Å–∫–∞
5. **–ö–æ–Ω—Ç—Ä–æ–ª—å** - –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –¥–∞–Ω–Ω—ã–º–∏
