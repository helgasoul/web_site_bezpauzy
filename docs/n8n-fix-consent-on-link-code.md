# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ n8n workflow: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ link_CODE

## üí° –ò–¥–µ—è

–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ `link_CODE` –≤ n8n workflow –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å `consent_granted = TRUE` –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—à–µ–ª —Å —Å–∞–π—Ç–∞. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.

## üîÑ –¢–µ–∫—É—â–∏–π flow –≤ n8n

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /start link_CODE –≤ –±–æ—Ç–∞
2. Extract link code - –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–¥
3. Get link code from DB - –Ω–∞—Ö–æ–¥–∏—Ç –∫–æ–¥, –ø–æ–ª—É—á–∞–µ—Ç website_user_id
4. Update user telegram_id - –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
5. ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: consent_granted –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å—Å—è –¥—É–±–ª–∏–∫–∞—Ç
```

## ‚úÖ –ù–æ–≤—ã–π flow (—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–≥–ª–∞—Å–∏–µ–º)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /start link_CODE –≤ –±–æ—Ç–∞
2. Extract link code - –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–¥
3. Get link code from DB - –Ω–∞—Ö–æ–¥–∏—Ç –∫–æ–¥, –ø–æ–ª—É—á–∞–µ—Ç website_user_id
4. Check if user exists - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ website_user_id
5. IF user exists:
   - Update user telegram_id - –æ–±–Ω–æ–≤–ª—è–µ—Ç telegram_id
   - Update user consent - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç consent_granted = TRUE
6. ELSE:
   - Create user - —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ (–Ω–æ —ç—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å, –µ—Å–ª–∏ –∫–æ–¥ —Å–æ–∑–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
```

## üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ n8n workflow

### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª "Check if user exists"

**–¢–∏–ø**: Supabase  
**–û–ø–µ—Ä–∞—Ü–∏—è**: get  
**–¢–∞–±–ª–∏—Ü–∞**: menohub_users  
**–§–∏–ª—å—Ç—Ä**:
```json
{
  "keyName": "id",
  "condition": "eq",
  "keyValue": "={{ $('Get link code from DB').item.json.website_user_id }}"
}
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏**:
- `Return All`: false
- `Return Empty Results`: true (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω)

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å IF —É–∑–µ–ª "User exists?"

**–¢–∏–ø**: IF  
**–£—Å–ª–æ–≤–∏–µ**:
```json
{
  "conditions": {
    "options": {
      "caseSensitive": true,
      "leftValue": "",
      "typeValidation": "strict"
    },
    "conditions": [
      {
        "id": "condition1",
        "leftValue": "={{ $json.id }}",
        "rightValue": "",
        "operator": {
          "type": "object",
          "operation": "exists"
        }
      }
    ],
    "combinator": "and"
  },
  "options": {}
}
```

**–°–æ–µ–¥–∏–Ω–µ–Ω–∏—è**:
- `true` ‚Üí "Update user telegram_id and consent"
- `false` ‚Üí "Create new user" (–Ω–æ —ç—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å)

### –®–∞–≥ 3: –û–±–Ω–æ–≤–∏—Ç—å —É–∑–µ–ª "Update user telegram_id"

**–¢–µ–∫—É—â–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ**: "Update user telegram_id"  
**–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ**: "Update user telegram_id and consent"

**–¢–∏–ø**: Supabase  
**–û–ø–µ—Ä–∞—Ü–∏—è**: update  
**–¢–∞–±–ª–∏—Ü–∞**: menohub_users  
**–§–∏–ª—å—Ç—Ä**:
```json
{
  "keyName": "id",
  "condition": "eq",
  "keyValue": "={{ $('Get link code from DB').item.json.website_user_id }}"
}
```

**Fields to Update**:
```json
{
  "telegram_id": "={{ $json.from.id }}",
  "consent_granted": true,
  "last_activity_at": "={{ $now }}"
}
```

**–í–∞–∂–Ω–æ**: 
- –ò—Å–ø–æ–ª—å–∑—É–µ–º `website_user_id` –∏–∑ —É–∑–ª–∞ "Get link code from DB"
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º `consent_granted = true`
- –û–±–Ω–æ–≤–ª—è–µ–º `last_activity_at`

### –®–∞–≥ 4: –£–¥–∞–ª–∏—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —É–∑–µ–ª "Create a row"

**–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω** (—á—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ):
- –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —É–∑–µ–ª "Create a row" –∫–∞–∫ fallback
- –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏

## üîç –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏

### –í–∞—Ä–∏–∞–Ω—Ç A: –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```
Get link code from DB
  ‚Üì
Check if user exists (–ø–æ website_user_id)
  ‚Üì
IF user exists:
  ‚Üí Update user telegram_id and consent
ELSE:
  ‚Üí Log error (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å)
```

### –í–∞—Ä–∏–∞–Ω—Ç B: –° –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ telegram_id

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ç–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º telegram_id:

```
Get link code from DB
  ‚Üì
Check if user exists by website_user_id
  ‚Üì
Check if user exists by telegram_id (–∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è)
  ‚Üì
IF user exists by website_user_id:
  ‚Üí Update user telegram_id and consent
ELSE IF user exists by telegram_id:
  ‚Üí Update user (–æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ)
ELSE:
  ‚Üí Create new user (–Ω–æ —ç—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å)
```

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ** - –Ω–µ –Ω—É–∂–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –≤ –±–æ—Ç–µ
2. ‚úÖ **–ù–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, –∞ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è
3. ‚úÖ **–ï–¥–∏–Ω–∞—è –∑–∞–ø–∏—Å—å** - –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è —Å–∞–π—Ç–∞ –∏ –±–æ—Ç–∞
4. ‚úÖ **–£–ª—É—á—à–µ–Ω–Ω—ã–π UX** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞

## üìù –ü—Ä–∏–º–µ—Ä JSON –¥–ª—è —É–∑–ª–∞ "Update user telegram_id and consent"

```json
{
  "operation": "update",
  "tableId": "menohub_users",
  "updateKey": "id",
  "updateAll": false,
  "fieldsUi": {
    "fieldValues": [
      {
        "fieldId": "telegram_id",
        "fieldValue": "={{ $json.from.id }}"
      },
      {
        "fieldId": "consent_granted",
        "fieldValue": "true"
      },
      {
        "fieldId": "last_activity_at",
        "fieldValue": "={{ $now }}"
      }
    ]
  },
  "options": {
    "skipOnConflict": false
  },
  "filters": {
    "conditions": [
      {
        "keyName": "id",
        "condition": "eq",
        "keyValue": "={{ $('Get link code from DB').item.json.website_user_id }}"
      }
    ]
  }
}
```

## üîÑ –°–≤—è–∑—å —Å —Ä–µ—à–µ–Ω–∏–µ–º –Ω–∞ —Å–∞–π—Ç–µ

–ù–∞ —Å–∞–π—Ç–µ —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω API endpoint (`app/api/auth/link-telegram/generate-code/route.ts`):
- –ü—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `consent_granted = TRUE`
- –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–ª —Å–æ–≥–ª–∞—Å–∏–µ, –ø–µ—Ä–µ—Ö–æ–¥—è —Å —Å–∞–π—Ç–∞ –≤ –±–æ—Ç–∞

–í n8n workflow –Ω—É–∂–Ω–æ:
- –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ `link_CODE` –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å `telegram_id` –∏ `consent_granted = TRUE` (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ)
- –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
- ‚úÖ –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ —Å —Å–∞–π—Ç–∞ –≤ –±–æ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–æ–≥–ª–∞—Å–∏–µ
- ‚úÖ –ù–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è —Å–∞–π—Ç–∞ –∏ –±–æ—Ç–∞
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–π UX - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞

