# Telegram –±–æ—Ç - –°–≤–æ–¥–∫–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. **–ü–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ callback –∫–Ω–æ–ø–æ–∫** (`lib/telegram/callbacks.ts`)

**13 —Ç–∏–ø–æ–≤ callbacks:**
- ‚úÖ `consent_agree` / `consent_decline` - —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ `40-45` / `46-50` / `50+` - –≤—ã–±–æ—Ä –≤–æ–∑—Ä–∞—Å—Ç–∞
- ‚úÖ `free_topic_hot_flashes` / `sleep` / `mood` / `weight` - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ç–µ–º—ã
- ‚úÖ `doctor` - —Å–ø–∞—Å–∏–±–æ –ø–æ—Å–ª–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤—Ä–∞—á–∞
- ‚úÖ `pay` / `oplata` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ (—Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–∞–π—Ç)
- ‚úÖ `select_another_topic` - –∑–∞–¥–∞—Ç—å –µ—â–µ –≤–æ–ø—Ä–æ—Å
- ‚úÖ `Thank_you` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
- ‚úÖ `listen_podcast` - —Å–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ –≤—Ä–∞—á–µ–π (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–¥–ø–∏—Å–∫–∏)
- ‚úÖ `video_{uuid}` - –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–∏–¥–µ–æ

### 2. **–ü—Ä–µ–¥–∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã** (`lib/telegram/free-topic-templates.ts`)

**4 —Ç–µ–º—ã —Å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É:**
- üå°Ô∏è –ü—Ä–∏–ª–∏–≤—ã (4000 —Å–∏–º–≤–æ–ª–æ–≤ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
- üò¥ –°–æ–Ω (–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã, –≥–∏–≥–∏–µ–Ω–∞ —Å–Ω–∞)
- üåà –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞)
- ‚öñÔ∏è –í–µ—Å (–º–µ—Ç–∞–±–æ–ª–∏–∑–º –∏ –ø–∏—Ç–∞–Ω–∏–µ)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:**
- –ü—Ä–æ—Å—Ç–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É (40-45 / 46-50 / 50+)
- –ù–∞—É—á–Ω—ã–µ —Ñ–∞–∫—Ç—ã
- –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã
- –ö–æ–≥–¥–∞ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –≤—Ä–∞—á—É
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã
- –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –≤—Ä–∞—á–∞
- –î–∏—Å–∫–ª–µ–π–º–µ—Ä

### 3. **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è AI –∞–≥–µ–Ω—Ç–æ–≤**

#### `lib/ai/tools/get-user-age.ts`
- –ü–æ–ª—É—á–∞–µ—Ç `age_range`, `city`, `telegram_id` –∏–∑ –ë–î
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º –∞–≥–µ–Ω—Ç–æ–º –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏

#### `lib/ai/tools/update-city.ts`
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≥–æ—Ä–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (–ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞ –∑–∞–≥–ª–∞–≤–Ω–∞—è)

#### `lib/ai/tools/search-doctors.ts`
- –ü–æ–∏—Å–∫ –≤—Ä–∞—á–µ–π –≤ `menohub_experts`
- –§–∏–ª—å—Ç—Ä –ø–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –≥–æ—Ä–æ–¥—É
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –∑–∞–ø–∏—Å–∏

#### –û–±–Ω–æ–≤–ª–µ–Ω `lib/ai/agent-tools.ts`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞ `menohub_experts` (–±—ã–ª–æ `menohub_doctors`)
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ–ª—è: `credentials`, `reviews_count`, `consultation_url`

### 4. **Flow —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏**

```
/start
  ‚Üì
–°–æ–≥–ª–∞—Å–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ ("–°–æ–≥–ª–∞—Å–µ–Ω" / "–û—Ç–∫–∞–∑–∞—Ç—å—Å—è")
  ‚Üì
[–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ menohub_users]
  ‚Üì
–í—ã–±–æ—Ä –≤–æ–∑—Ä–∞—Å—Ç–∞ (40-45 / 46-50 / 50+)
  ‚Üì
[–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ age_range –≤ –ë–î]
  ‚Üì
–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ç–µ–º—ã (4 –∫–Ω–æ–ø–∫–∏ + "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å")
  ‚Üì
–ü—Ä–µ–¥–∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å
```

### 5. **–í–∏–¥–µ–æ "–í—Ä–∞—á–∏ –û–±—ä—è—Å–Ω—è—é—Ç"** (–ø–ª–∞—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ö–Ω–æ–ø–∫–∞ "–°–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ –≤—Ä–∞—á–µ–π"
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (`is_subscribed`, `subscription_plan`)
- –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç ‚Üí –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ñ–æ—Ä–º–∏—Ç—å
- –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –µ—Å—Ç—å ‚Üí —Å–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ –∏–∑ `menohub_video_content`
- –í—ã–±–æ—Ä –≤–∏–¥–µ–æ ‚Üí –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è + —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–∞–π—Ç
- –°—á–µ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (RPC function `increment_video_views`)

**Callback format:**
- `listen_podcast` - –æ—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫
- `video_{uuid}` - –≤—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤–∏–¥–µ–æ

### 6. **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ**

**Callbacks:** `pay` –∏–ª–∏ `oplata`

**–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:**
- –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤ –ø–æ–¥–ø–∏—Å–∫–∏
- –¢–∞—Ä–∏—Ñ—ã (–º–µ—Å—è—Ü, 3 –º–µ—Å—è—Ü–∞, –≥–æ–¥)
- –ö–Ω–æ–ø–∫–∞ —Å–æ —Å—Å—ã–ª–∫–æ–π: `https://bez-pauzy.ru/pricing`

### 7. **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î**

**`supabase/migrations/056_add_increment_video_views_function.sql`**
- RPC —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ callbacks –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≤–∏–¥–µ–æ

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
lib/telegram/
‚îú‚îÄ‚îÄ bot.ts                       # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (‚úÖ –±—ã–ª–æ)
‚îú‚îÄ‚îÄ callbacks.ts                 # ‚úÖ –ù–û–í–û–ï - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
‚îú‚îÄ‚îÄ commands.ts                  # –ö–æ–º–∞–Ω–¥—ã /start, /export –∏ —Ç.–¥. (‚úÖ –±—ã–ª–æ)
‚îú‚îÄ‚îÄ free-topic-templates.ts      # ‚úÖ –ù–û–í–û–ï - —à–∞–±–ª–æ–Ω—ã –¥–ª—è —Ç–µ–º
‚îú‚îÄ‚îÄ message-handler.ts           # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (‚úÖ –±—ã–ª–æ)
‚îî‚îÄ‚îÄ webhook-handler.ts           # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π (‚úÖ –±—ã–ª–æ)

lib/ai/
‚îú‚îÄ‚îÄ message-processor.ts         # –ï–¥–∏–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä (‚úÖ –±—ã–ª–æ)
‚îú‚îÄ‚îÄ main-agent.ts                # –û—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç (‚úÖ –±—ã–ª–æ)
‚îú‚îÄ‚îÄ agent.ts                     # –ê–≥–µ–Ω—Ç –ø–æ–∏—Å–∫–∞ –≤—Ä–∞—á–µ–π (‚úÖ –±—ã–ª–æ)
‚îú‚îÄ‚îÄ main-agent-tools.ts          # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ (‚úÖ –±—ã–ª–æ)
‚îú‚îÄ‚îÄ agent-tools.ts               # ‚úÖ –û–ë–ù–û–í–õ–ï–ù–û - search_doctors
‚îî‚îÄ‚îÄ tools/
    ‚îú‚îÄ‚îÄ get-user-age.ts          # ‚úÖ –ù–û–í–û–ï
    ‚îú‚îÄ‚îÄ update-city.ts           # ‚úÖ –ù–û–í–û–ï
    ‚îî‚îÄ‚îÄ search-doctors.ts        # ‚úÖ –ù–û–í–û–ï

docs/
‚îú‚îÄ‚îÄ TELEGRAM_BOT_MIGRATION.md    # ‚úÖ –ù–û–í–û–ï - –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ n8n
‚îú‚îÄ‚îÄ TELEGRAM_BOT_TESTING.md      # ‚úÖ –ù–û–í–û–ï - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ–ø–ª–æ–π
‚îî‚îÄ‚îÄ TELEGRAM_BOT_SUMMARY.md      # ‚úÖ –ù–û–í–û–ï - —ç—Ç–æ —Ä–µ–∑—é–º–µ

supabase/migrations/
‚îî‚îÄ‚îÄ 056_add_increment_video_views_function.sql  # ‚úÖ –ù–û–í–û–ï
```

---

## üéØ –ß—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç n8n

| n8n workflow | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ –∫–æ–¥–µ | –°—Ç–∞—Ç—É—Å |
|--------------|-------------------|---------|
| Telegram Trigger | `app/api/telegram/webhook/route.ts` | ‚úÖ |
| –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö | `callbacks.ts` ‚Üí `handleConsentAgree()` | ‚úÖ |
| –í—ã–±–æ—Ä –≤–æ–∑—Ä–∞—Å—Ç–∞ | `callbacks.ts` ‚Üí `handleAgeSelection()` | ‚úÖ |
| –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ç–µ–º—ã | `free-topic-templates.ts` + `callbacks.ts` | ‚úÖ |
| AI Agent (–æ—Å–Ω–æ–≤–Ω–æ–π) | `main-agent.ts` + –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã | ‚úÖ |
| AI Agent1 (–≤—Ä–∞—á–∏) | `agent.ts` + `search_doctors` | ‚úÖ |
| Vector_store | `main-agent-tools.ts` ‚Üí `vectorStoreTool` | ‚úÖ |
| Get_user_age | `tools/get-user-age.ts` | ‚úÖ |
| Update_city | `tools/update-city.ts` | ‚úÖ |
| search_doctors | `tools/search-doctors.ts` | ‚úÖ |
| Research (Perplexity) | –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –∞–≥–µ–Ω—Ç–∞—Ö | ‚úÖ |
| –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥ | –í—Å—Ç—Ä–æ–µ–Ω –≤ –∞–≥–µ–Ω—Ç—ã | ‚úÖ |
| –û–ø–ª–∞—Ç–∞ | `callbacks.ts` ‚Üí `handlePaymentInfo()` | ‚úÖ |
| –ü–æ–¥–∫–∞—Å—Ç/–í–∏–¥–µ–æ | `callbacks.ts` ‚Üí `handleDoctorsVideos()` | ‚úÖ |

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ ngrok)

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å dev —Å–µ—Ä–≤–µ—Ä
npm run dev

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å ngrok
ngrok http 3000

# 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook
curl -X POST "https://api.telegram.org/botTOKEN/setWebhook" \
  -d "url=https://xxxx.ngrok-free.app/api/telegram/webhook"

# 4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É
```

–°–º. –ø–æ–ª–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç –≤ `docs/TELEGRAM_BOT_TESTING.md`

### 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏

```sql
-- –í Supabase SQL Editor:
-- 055_add_doctors_explain_content_type.sql (–µ—Å–ª–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞)
-- 056_add_increment_video_views_function.sql
```

### 3. –î–µ–ø–ª–æ–π –Ω–∞ Vercel

```bash
# 1. –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å
git add .
git commit -m "feat: –º–∏–≥—Ä–∞—Ü–∏—è Telegram –±–æ—Ç–∞ –∏–∑ n8n –≤ –∫–æ–¥"
git push origin main

# 2. –î–æ–∂–¥–∞—Ç—å—Å—è –¥–µ–ø–ª–æ—è Vercel

# 3. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å webhook
curl -X POST "https://api.telegram.org/botTOKEN/setWebhook" \
  -d "url=https://bez-pauzy.vercel.app/api/telegram/webhook"

# 4. –û—Ç–∫–ª—é—á–∏—Ç—å n8n workflow
```

### 4. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç

- –í—Ä–∞—á–∏ –≤ `menohub_experts`
- –í–∏–¥–µ–æ –≤ `menohub_video_content` (content_type='doctors_explain')
- –î–æ–∫—É–º–µ–Ω—Ç—ã –≤ `menohub_documents` –¥–ª—è Vector Store

---

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:

1. ‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –∫–æ–¥–µ Next.js
2. ‚úÖ n8n –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω (–º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å)
3. ‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ —É–ª—É—á—à–µ–Ω—ã
4. ‚úÖ –õ–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å
5. ‚úÖ –ï–¥–∏–Ω–∞—è –∫–æ–¥–æ–≤–∞—è –±–∞–∑–∞ (—Å–∞–π—Ç + –±–æ—Ç)
6. ‚úÖ –ú–µ–Ω—å—à–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ —Ç–æ—á–µ–∫ –æ—Ç–∫–∞–∑–∞

**–ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!** üöÄ
