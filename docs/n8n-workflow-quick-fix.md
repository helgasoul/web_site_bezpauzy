# –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ n8n workflow –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ Telegram

## –ü—Ä–æ–±–ª–µ–º–∞ 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `website_user_id` –≤–º–µ—Å—Ç–æ `user_id`

### –£–∑–µ–ª: "Update user telegram_id"

**–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞:**
```json
{
  "keyName": "id",
  "condition": "eq",
  "keyValue": "=={{ $json.user_id }}"
}
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:**
```json
{
  "keyName": "id",
  "condition": "eq",
  "keyValue": "=={{ $('Get link code from DB').item.json.website_user_id }}"
}
```

**–í–∞–∂–Ω–æ**: –ï—Å–ª–∏ `website_user_id` –º–æ–∂–µ—Ç –±—ã—Ç—å `null` (—Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏), –¥–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É:

### –ù–æ–≤—ã–π —É–∑–µ–ª –ø–µ—Ä–µ–¥ "Update user telegram_id": "IF website_user_id exists"

**–¢–∏–ø**: IF  
**–£—Å–ª–æ–≤–∏–µ**:
```json
{
  "leftValue": "=={{ $('Get link code from DB').item.json.website_user_id }}",
  "rightValue": "",
  "operator": {
    "type": "string",
    "operation": "exists",
    "singleValue": true
  }
}
```

**–°–æ–µ–¥–∏–Ω–µ–Ω–∏—è**:
- `true` ‚Üí "Update user telegram_id"
- `false` ‚Üí –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–∫–æ–¥ –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)

---

## –ü—Ä–æ–±–ª–µ–º–∞ 2: –ü–æ–∫–∞–∑ —Å–æ–≥–ª–∞—Å–∏—è –¥–ª—è —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º —Å–æ–≥–ª–∞—Å–∏—è

**–ú–µ—Å—Ç–æ**: –ü–æ—Å–ª–µ —É–∑–ª–∞ "If" (–ø—Ä–æ–≤–µ—Ä–∫–∞ `/start`), –ø–µ—Ä–µ–¥ —É–∑–ª–æ–º "IF Link_?"

### –ù–æ–≤—ã–π —É–∑–µ–ª 1: "Get user by telegram_id" (Supabase)

**–ü–æ–∑–∏—Ü–∏—è**: –ú–µ–∂–¥—É "If" –∏ "IF Link_?"

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
```json
{
  "operation": "getAll",
  "tableId": "menohub_users",
  "limit": 1,
  "matchType": "allFilters",
  "filters": {
    "conditions": [
      {
        "keyName": "telegram_id",
        "condition": "eq",
        "keyValue": "={{ $('Telegram Trigger').item.json.message.from.id }}"
      },
      {
        "keyName": "telegram_id",
        "condition": "neq",
        "keyValue": "0"
      }
    ]
  }
}
```

### –ù–æ–≤—ã–π —É–∑–µ–ª 2: "IF User already linked" (IF)

**–ü–æ–∑–∏—Ü–∏—è**: –ü–æ—Å–ª–µ "Get user by telegram_id"

**–£—Å–ª–æ–≤–∏–µ**:
```json
{
  "leftValue": "=={{ $json.id }}",
  "rightValue": "",
  "operator": {
    "type": "string",
    "operation": "exists",
    "singleValue": true
  }
}
```

**–°–æ–µ–¥–∏–Ω–µ–Ω–∏—è**:
- `true` ‚Üí **–ù–æ–≤—ã–π —É–∑–µ–ª**: "Send welcome message" (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö)
- `false` ‚Üí –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —É–∑–µ–ª "IF Link_?"

### –ù–æ–≤—ã–π —É–∑–µ–ª 3: "Send welcome message" (Telegram)

**–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è**:
```
üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –≤ "–ë–µ–∑ |–ü–∞—É–∑—ã"!

–í—ã —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –∞–∫–∫–∞—É–Ω—Ç—É –Ω–∞ —Å–∞–π—Ç–µ.
–ú–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –æ–±—â–µ–Ω–∏–µ —Å –ï–≤–æ–π!

üí¨ –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
```

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ**: –î–æ–±–∞–≤—å—Ç–µ inline-–∫–Ω–æ–ø–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π

---

## –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ workflow

```
Telegram Trigger
  ‚Üì
If (—Å–æ–¥–µ—Ä–∂–∏—Ç "/start")
  ‚Üì (true)
Get user by telegram_id
  ‚Üì
IF User already linked
  ‚îú‚îÄ (true) ‚Üí Send welcome message
  ‚îî‚îÄ (false) ‚Üí IF Link_?
                ‚îú‚îÄ (true) ‚Üí Extract link code ‚Üí Get link code from DB ‚Üí IF website_user_id exists ‚Üí Update user telegram_id
                ‚îî‚îÄ (false) ‚Üí Send a text message (—Å–æ–≥–ª–∞—Å–∏–µ)
```

**–í–ê–ñ–ù–û**: –¢–∞–∫–∂–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å `link_` (–±–µ–∑ `/start`):

```
Telegram Trigger
  ‚Üì
IF message starts with "link_" (–ù–û–í–´–ô –£–ó–ï–õ)
  ‚Üì (true)
Extract link code ‚Üí Get link code from DB ‚Üí IF website_user_id exists ‚Üí Update user telegram_id
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–æ—Å—Ç–æ `link_–ö–û–î` –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã `/start`.

---

## –í–∞–∂–Ω–æ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º

1. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é** –≤ Supabase:
   ```sql
   -- –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª: supabase/migrations/013_fix_telegram_auth_codes_user_id.sql
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏**: –ï—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `menohub_telegram_auth_codes` –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏ –±–µ–∑ `website_user_id`, –æ–Ω–∏ –Ω–µ —Å–º–æ–≥—É—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ:
   - –õ–∏–±–æ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –∏—Ö –≤—Ä—É—á–Ω—É—é
   - –õ–∏–±–æ –¥–æ–±–∞–≤—å—Ç–µ fallback-–ª–æ–≥–∏–∫—É –≤ workflow

3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏**:
   - –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: `/start` ‚Üí –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ
   - –ü—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: `/start` ‚Üí –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
   - –ü—Ä–∏–≤—è–∑–∫–∞ —á–µ—Ä–µ–∑ deep link: `/start link_–ö–û–î` ‚Üí –¥–æ–ª–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É
   - –ü—Ä–∏–≤—è–∑–∫–∞ –≤—Ä—É—á–Ω—É—é: `link_–ö–û–î` (–±–µ–∑ /start) ‚Üí –¥–æ–ª–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É

4. **–û–±–Ω–æ–≤–∏—Ç–µ —É–∑–µ–ª "Extract link code"** –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤:
   - `/start link_–ö–û–î` (–∏–∑ deep link)
   - `link_–ö–û–î` (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª –≤—Ä—É—á–Ω—É—é)
   
   –°–º. –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ `docs/telegram-handle-link-code-without-start.md`

