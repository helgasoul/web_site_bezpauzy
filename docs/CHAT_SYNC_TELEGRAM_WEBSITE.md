# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ –º–µ–∂–¥—É Telegram –∏ —Å–∞–π—Ç–æ–º

## üéØ –¶–µ–ª—å

–°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—É—é —Å–∏—Å—Ç–µ–º—É —á–∞—Ç–∞, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ–±—â–∞—Ç—å—Å—è —Å –ï–≤–æ–π –∏ –≤ Telegram, –∏ –Ω–∞ —Å–∞–π—Ç–µ, –ø—Ä–∏ —ç—Ç–æ–º:
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –º–µ–∂–¥—É –∫–∞–Ω–∞–ª–∞–º–∏
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–±–æ–∏—Ö –º–µ—Å—Ç–∞—Ö
- ‚úÖ –ï–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ï–¥–∏–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (`menohub_queries`)

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:

```
Telegram ‚Üí n8n ‚Üí Supabase (menohub_queries)
Website ‚Üí API ‚Üí Supabase (menohub_queries)
```

### –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:

```
Telegram ‚Üí Webhook ‚Üí –ï–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ‚Üí Supabase (menohub_queries)
Website ‚Üí API ‚Üí –ï–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ‚Üí Supabase (menohub_queries)
```

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### 1. –°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ Telegram:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
2. Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ /api/telegram/webhook
3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ menohub_queries —Å source='telegram'
4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ Claude API
5. –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ menohub_queries
6. –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ Telegram
7. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω –Ω–∞ —Å–∞–π—Ç–µ ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ polling
```

### 2. –°–æ–æ–±—â–µ–Ω–∏–µ —Å —Å–∞–π—Ç–∞:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å–∞–π—Ç–µ
2. API /api/chat/send-message –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ menohub_queries —Å source='website'
4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ Claude API (—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞)
5. –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ menohub_queries
6. –û—Ç–≤–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞ —Å–∞–π—Ç
7. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã—Ç –≤ Telegram ‚Üí –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

## üìù –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã menohub_queries

–¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —É–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é:

```sql
menohub_queries (
  id UUID PRIMARY KEY,
  user_id BIGINT REFERENCES menohub_users(id),
  query_text TEXT,
  response_text TEXT,
  query_status TEXT, -- 'pending', 'processing', 'completed', 'failed'
  source TEXT, -- 'telegram', 'website'
  telegram_message_id BIGINT, -- ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram (–µ—Å–ª–∏ –∏–∑ Telegram)
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
)
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å:**
- `source` - 'telegram' –∏–ª–∏ 'website'
- `telegram_message_id` - –¥–ª—è —Å–≤—è–∑–∏ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –≤ Telegram

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Telegram webhook

**–§–∞–π–ª:** `lib/telegram/message-handler.ts`

```typescript
// –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram:
// 1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ menohub_queries —Å source='telegram'
// 2. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
// 3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç
// 4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
```

### 2. –û–±–Ω–æ–≤–∏—Ç—å API –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Å–∞–π—Ç–∞

**–§–∞–π–ª:** `app/api/chat/send-message/route.ts`

```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—É –∂–µ –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏, —á—Ç–æ –∏ –¥–ª—è Telegram
// –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å source='website'
```

### 3. –°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π

**–§–∞–π–ª:** `lib/ai/message-processor.ts`

```typescript
// –ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:
// - –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (Lakera)
// - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (RAG)
// - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ (Claude)
// - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
```

### 4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

**–í–∞—Ä–∏–∞–Ω—Ç 1: Polling (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
- –°–∞–π—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ `/api/chat/poll`

**–í–∞—Ä–∏–∞–Ω—Ç 2: WebSocket (–¥–ª—è –±—É–¥—É—â–µ–≥–æ)**
- Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

## üì± UX –Ω–∞ —Å–∞–π—Ç–µ

### –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:

```
üí¨ –ß–∞—Ç —Å –ï–≤–æ–π
üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å Telegram

[–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π]
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö:

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram, –Ω–∞ —Å–∞–π—Ç–µ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å:
```
üîî –£ –≤–∞—Å –µ—Å—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ï–≤—ã –≤ Telegram
[–ö–Ω–æ–ø–∫–∞: –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç]
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   - Telegram: –ø–æ `telegram_id`
   - Website: –ø–æ `user_id` –∏–∑ —Å–µ—Å—Å–∏–∏
   - –û–±–∞ –¥–æ–ª–∂–Ω—ã —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ `menohub_users`

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
   - Rate limiting
   - –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ï–¥–∏–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è:**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–±–æ–∏—Ö –º–µ—Å—Ç–∞—Ö
   - –ù–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç

2. **–ì–∏–±–∫–æ—Å—Ç—å:**
   - –ú–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä –≤ Telegram, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–∞ —Å–∞–π—Ç–µ
   - –ò –Ω–∞–æ–±–æ—Ä–æ—Ç

3. **–£–¥–æ–±—Å—Ç–≤–æ:**
   - Telegram –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Ö–æ–¥—É
   - –°–∞–π—Ç –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –∏ —á—Ç–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏

4. **–ï–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞:**
   - –û–¥–∏–Ω –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
   - –õ–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ —Å–∞–π—Ç–µ
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å–∞–π—Ç–µ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Telegram (–µ—Å–ª–∏ –µ—Å—Ç—å telegram_id)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤ –æ–±–æ–∏—Ö –º–µ—Å—Ç–∞—Ö
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º (telegram/website)
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
- –û—à–∏–±–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –æ–±–∞ –∫–∞–Ω–∞–ª–∞
