# Лимит загрузки в Storage на Beget: как увеличить

У вас Supabase/Storage доступен по адресу `pooycaduebookel.beget.app`. Ошибка «File size exceeds the bucket upload limit» может быть из двух мест: **веб‑сервер перед Storage** (nginx) или **сам сервис Storage**. Ниже — что проверить и куда залезать на Beget.

---

## Почему «я увеличила объём памяти», а ошибка остаётся

**Объём памяти (RAM, диск)** в разделе «Текущая конфигурация» / «Change» — это ресурсы самого сервера (сколько оперативной памяти и места на диске у Supabase). Их увеличение **не меняет** лимит «максимальный размер одного загружаемого файла».

Лимит загрузки задаётся отдельно:
1. **nginx** — директива `client_max_body_size` (часто 1 MB по умолчанию),
2. **Supabase Storage** — переменная `FILE_SIZE_LIMIT` или настройка bucket в БД.

Поэтому после увеличения памяти ошибка «File size exceeds the bucket upload limit» никуда не денется, пока не поднять именно эти два параметра (или не уменьшить размер файла / не положить видео на другой хостинг). Ниже — где их менять и что делать, если доступа нет.

---

## Куда идти в панели Beget Cloud (Server Configuration)

На экране «Server Configuration Gladdening Wynn»:

| Что видите | Куда идти и зачем |
|------------|-------------------|
| **Change** рядом с «Standard 3+ GHz» (Текущая конфигурация) | Меняет **ресурсы сервера**: ядра, RAM, диск (80 GB NVMe). Это не лимит «размер одного файла при загрузке». Нужно только если не хватает места на диске. |
| **File Manager** (доступ к файлам сервера включён) | Через него можно смотреть конфиги (nginx, .env), если знаете пути. Для лимита загрузки сами файлы обычно правят через SSH. |
| **Reinstall** у Supabase | Переустановка. Не нажимать ради лимита. |

Чтобы поднять лимит загрузки **одного файла**, нужны либо конфиг nginx, либо переменные окружения Supabase Storage. В этой панели ищите:

1. **Терминал / SSH / Консоль** — отдельная вкладка или пункт в меню сервера («Gladdening Wynn»). Оттуда по SSH заходите на сервер и правите конфиги (см. разделы 1 и 2 ниже).
2. **Раздел Supabase** — если при выборе Supabase или сервера есть подразделы вроде «Переменные окружения», «Конфигурация», «Настройки приложения» — там может быть `FILE_SIZE_LIMIT` или ссылка на конфиги.
3. **Левое меню** — при выборе сервера «Gladdening Wynn» часто есть пункты: обзор, файлы, базы, бэкапы, сеть, мониторинг и т.п. Зайдите в «Файлы» или «Терминал», если есть.

Если в панели нет ни Терминала, ни доступа к переменным Supabase — напишите в поддержку Beget: «Как на облачном сервере с Supabase увеличить максимальный размер загружаемого файла в Storage (сейчас лимит срабатывает на файлах больше N MB)?» и приложите скрин этой страницы.

---

## «Failed to update bucket: API error...» при сохранении лимита

Если в окне **Edit bucket** вы ставите «Restrict file upload size» (например 500 MB для `menohub_videos`) и нажимаете **Save**, но появляется **«Failed to update bucket: API error happened while trying to communicate with the server»** — настройки **не применились**. Так бывает на части хостингов (в т.ч. Beget): UI не может сохранить лимит.

**Что сделать:**

1. **Задать лимит через SQL** — в Supabase откройте **SQL Editor**, выполните запрос из [docs/storage-bucket-file-size-limit.sql](storage-bucket-file-size-limit.sql). Для `menohub_videos` подойдёт, например:
   ```sql
   UPDATE storage.buckets
   SET file_size_limit = 524288000   -- 500 MB
   WHERE name = 'menohub_videos';
   ```
   После этого лимит будет взят из БД, даже если Edit bucket в UI по-прежнему выдаёт ошибку.

2. **Если через UI всё же хочется** — попробовать сохранить ещё раз, уменьшить значение (100 MB, 1 GB) или проверить глобальный лимит Storage (Storage Settings). Лимит bucket не может быть выше глобального.

3. **Поддержка Beget** — скрин с «Failed to update bucket» и просьба поднять лимит загрузки или подсказать, где править nginx / переменные Storage.

Пока лимит через интерфейс не сохраняется, используют **обход:** либо SQL выше, либо сжать видео / положить на внешний хостинг и указать URL в `NEXT_PUBLIC_WELCOME_VIDEO_URL` (см. [docs/welcome-video-limit-workaround.md](welcome-video-limit-workaround.md)).

---

## Лимит в bucket убрала, но он всё ещё действует

Если вы **отключили** «Restrict file upload size» для bucket (или поставили «без лимита»), а ошибка «File size exceeds the bucket upload limit» или обрезка загрузки **остаётся** — ограничение может идти не из настроек bucket.

**Где ещё может стоять лимит:**

1. **Глобальный лимит Storage** — в том же разделе Storage часто есть общая настройка «Global file size limit» / «Максимальный размер файла». Она действует поверх настроек bucket: даже при «без лимита» в bucket глобальный лимит может резать. Нужно поднять или отключить именно его (если интерфейс это позволяет).

2. **Nginx** — до Storage запрос проходит через веб‑сервер. У nginx по умолчанию `client_max_body_size` чаще всего 1 MB. Запросы с телом больше этого отсекаются до того, как попадут в Storage, и вы можете видеть ошибку про размер или «413 Request Entity Too Large». Меняется только в конфиге nginx (или через поддержку хостинга). См. раздел «1. Nginx: client_max_body_size» ниже.

3. **Переменная Storage** — у сервиса Supabase Storage может быть своя переменная окружения `FILE_SIZE_LIMIT`. Она задаётся при развёртывании (env контейнера/сервиса) и не меняется из веб‑интерфейса bucket. На Beget её можно поменять только через SSH/конфиг или поддержку.

**Итог:** пока не подняты лимиты на всех уровнях (глобальный в Storage, nginx, при необходимости `FILE_SIZE_LIMIT`), снятие лимита только в bucket может не дать эффекта. Если доступа к nginx и env нет — остаётся обход: сжать файл или положить видео на внешний хостинг и использовать его URL в `NEXT_PUBLIC_WELCOME_VIDEO_URL`.

---

## Схема: откуда берётся лимит

1. **Nginx (или другой прокси)** — режет запросы по размеру тела. Если лимит маленький, до Storage вообще не доходит, бывает **413 Request Entity Too Large** или ответ от обвязки.
2. **Сервис Storage** (Supabase Storage API) — проверяет свой лимит (в БД для bucket или в переменной окружения).

Нужно поднять оба, если хотите грузить большие файлы.

---

## 1. Nginx: `client_max_body_size`

По умолчанию nginx разрешает тело запроса **1 MB**. Загрузка файла — это тело запроса, поэтому лимит нужно увеличить.

### Где править на Beget

- **VPS Beget** — есть свой сервер, SSH, свои конфиги. Ниже — варианты для него.
- **Обычный виртуальный хостинг Beget** — своего nginx вы не трогаете. Варианты: написать в техподдержку Beget с просьбой поднять лимит для домена/поддомена `pooycaduebookel.beget.app`, либо использовать только сжатое/маленькое видео.

### Если есть доступ к nginx (VPS / свой сервер)

Найти конфиг, в котором описан `pooycaduebookel.beget.app` или общий `server`/`http`:

```bash
# Часто конфиги лежат здесь:
/etc/nginx/nginx.conf
/etc/nginx/conf.d/*.conf
/etc/nginx/sites-enabled/*
```

В нужный блок `http` или `server` (лучше для этого домена) добавить или изменить:

```nginx
client_max_body_size 100m;
```

Пример для отдельного `server`:

```nginx
server {
    listen 80;
    server_name pooycaduebookel.beget.app;
    client_max_body_size 100m;   # максимум 100 MB на один запрос

    location / {
        # ваша текущая конфигурация (proxy_pass к Storage и т.д.)
    }
}
```

Сохранить конфиг, проверить и перезагрузить nginx:

```bash
nginx -t
systemctl reload nginx
# или
service nginx reload
```

Если не знаете, в каком файле править — ищите по домену:

```bash
grep -r "pooycaduebookel" /etc/nginx/
```

---

## 2. Supabase Storage: лимит в самом сервисе

Если на Beget крутится **свой (self‑hosted) Supabase Storage**, у него есть переменная окружения **`FILE_SIZE_LIMIT`** — максимальный размер файла в байтах.

### Где это задаётся

Зависит от того, как у вас поднят Storage на Beget:

- **Docker / docker-compose** — в `.env` или в `environment` контейнера со Storage.
- **Systemd / сервис** — в unit-файле или в файле окружения, откуда сервис запускается.
- **Панель Beget (если есть «переменные окружения»)** — туда добавить `FILE_SIZE_LIMIT`.

### Какое значение поставить

В байтах, например:

- 50 MB: `52428800`
- 100 MB: `104857600`
- 500 MB: `524288000`
- 1 GB: `1073741824`

Пример для `.env` контейнера Storage:

```env
FILE_SIZE_LIMIT=104857600
```

Имеет смысл поставить столько же или меньше, чем `client_max_body_size` в nginx (чтобы nginx не резал раньше Storage).

После смены переменной контейнер/сервис Storage нужно перезапустить.

---

## 3. База данных (bucket) — уже пробовали

Вы уже выполняли SQL к `storage.buckets` и меняли `file_size_limit`. Если ошибка «limit exceeded» всё равно приходит от Storage (а не 413 от nginx), то либо:

- лимит на вашем инстансе задаётся не в БД, а только через `FILE_SIZE_LIMIT`,  
- либо перед Storage стоит nginx с маленьким `client_max_body_size`, и запрос обрезается до того, как дойдёт до Storage.

Поэтому сначала убедитесь, что nginx и (при возможности) `FILE_SIZE_LIMIT` выставлены, а SQL оставьте как дополнительную настройку.

---

## 4. Что сделать по шагам на Beget

1. **Понять тип хостинга**  
   У вас VPS Beget с SSH и своими конфигами или обычный виртуальный хостинг без доступа к nginx?

2. **Если есть доступ к серверу (VPS):**
   - В конфиге nginx для `pooycaduebookel.beget.app` (или в общем `http`/`server`) выставить `client_max_body_size 100m;` (или нужный размер).
   - Найти, где запущен Supabase Storage, и задать `FILE_SIZE_LIMIT` в его окружении (например в `.env` контейнера), затем перезапустить Storage.

3. **Если доступа к nginx/серверу нет:**  
   Написать в техподдержку Beget: «Нужно увеличить максимальный размер загружаемого файла для домена pooycaduebookel.beget.app (сейчас при загрузке больше N MB выходит ошибка). Можете ли вы поднять лимит до 50/100 MB?»  
   Часто это делают через `client_max_body_size` в своей конфигурации nginx.

4. **Проверка**  
   После изменений снова загрузить тот же файл в Storage. Если ошибка изменилась с «limit exceeded» на **413** — режем лимит в nginx. Если остаётся прежнее сообщение — ищем `FILE_SIZE_LIMIT` и настройки bucket/БД.

---

## Кратко

| Где лимит        | Что сделать на Beget |
|------------------|----------------------|
| Nginx            | В конфиге для домена добавить `client_max_body_size 100m;`, перезагрузить nginx (если есть доступ). Иначе — запрос в техподдержку. |
| Storage (сервис) | В окружении сервиса Supabase Storage задать `FILE_SIZE_LIMIT=104857600` (или нужный размер в байтах), перезапустить Storage. |
| База (bucket)    | Оставить уже сделанный SQL по `storage.buckets` как есть; при self‑hosted главное — nginx и `FILE_SIZE_LIMIT`. |

Если напишете, есть ли у вас SSH/доступ к конфигам на Beget и как именно там запущен Supabase (Docker, панель, что-то ещё), можно сузить инструкцию под вашу схему.
