# –ú–∏–≥—Ä–∞—Ü–∏—è Telegram –±–æ—Ç–∞ –∏–∑ n8n –≤ –∫–æ–¥

## üìä –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ n8n —Å—Ü–µ–Ω–∞—Ä–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ workflow

#### 1. **–¢—Ä–∏–≥–≥–µ—Ä**
- `Telegram Trigger` - –ø–æ–ª—É—á–∞–µ—Ç `message` –∏ `callback_query`

#### 2. **–û—Å–Ω–æ–≤–Ω–æ–π flow**

```
Telegram Trigger
    ‚Üì
[/start –∫–æ–º–∞–Ω–¥–∞?] ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    ‚Üì
[–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞?]
    ‚îú‚îÄ consent_agree ‚Üí –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –°–ø—Ä–æ—Å–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç
    ‚îú‚îÄ consent_decline ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–∫–∞–∑–µ
    ‚îú‚îÄ 40-45/46-50/50+ ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç ‚Üí –ü–æ–∫–∞–∑–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ç–µ–º—ã
    ‚îú‚îÄ free_topic_* ‚Üí –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—ã–±–æ—Ä —Ç–µ–º—ã ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
    ‚îú‚îÄ doctor ‚Üí –°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
    ‚îú‚îÄ pay/oplata ‚Üí –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ
    ‚îú‚îÄ select_another_topic ‚Üí –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å
    ‚îú‚îÄ Thank_you ‚Üí –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    ‚îî‚îÄ listen_podcast ‚Üí –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–∫–∞—Å—Ç
    ‚Üì
[–û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ] ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    ‚îú‚îÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –Ω–∞–π–¥–µ–Ω ‚Üí /start
    ‚îî‚îÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω
        ‚Üì
        –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞
        ‚îú‚îÄ –ü–æ–∏—Å–∫ –≤—Ä–∞—á–µ–π ‚Üí AI Agent1 (search_doctors + research)
        ‚îî‚îÄ –û–±—ã—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å ‚Üí AI Agent (Vector_store + Research)
        ‚Üì
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ menohub_queries ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
```

---

## üéØ Callback –∫–Ω–æ–ø–∫–∏ (–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫)

### 1. **–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö**
- `consent_agree` - –°–æ–≥–ª–∞—Å–µ–Ω
- `consent_decline` - –û—Ç–∫–∞–∑–∞—Ç—å—Å—è

### 2. **–í—ã–±–æ—Ä –≤–æ–∑—Ä–∞—Å—Ç–∞**
- `40-45` - 40-45 –ª–µ—Ç
- `46-50` - 46-50 –ª–µ—Ç
- `50+` - 50+ –ª–µ—Ç

### 3. **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ç–µ–º—ã (–ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞)**
- `free_topic_hot_flashes` - –ü—Ä–∏–ª–∏–≤—ã
- `free_topic_sleep` - –°–æ–Ω
- `free_topic_mood` - –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
- `free_topic_weight` - –í–µ—Å

### 4. **–î–µ–π—Å—Ç–≤–∏—è –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞**
- `doctor` - –°–ø–∞—Å–∏–±–æ (–ø–æ—Å–ª–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤—Ä–∞—á–∞)
- `select_another_topic` - –ó–∞–¥–∞—Ç—å –µ—â–µ –≤–æ–ø—Ä–æ—Å
- `Thank_you` - –í—Å—ë –ø–æ–Ω—è—Ç–Ω–æ

### 5. **–û–ø–ª–∞—Ç–∞**
- `pay` - –û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- `oplata` - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ

### 6. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ**
- `listen_podcast` - –ü–æ—Å–ª—É—à–∞—Ç—å –ø–æ–¥–∫–∞—Å—Ç

---

## ü§ñ AI –ê–≥–µ–Ω—Ç—ã

### **AI Agent** (–æ—Å–Ω–æ–≤–Ω–æ–π - –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã)

**–†–æ–ª—å:** –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–æ–º–æ—â–Ω–∏—Ü–∞ –ø–æ –∂–µ–Ω—Å–∫–æ–º—É –∑–¥–æ—Ä–æ–≤—å—é

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
1. `Get_user_age` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏–∑ –ë–î (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–∑—ã–≤–∞—Ç—å –ø–µ—Ä–≤—ã–º!)
2. `Update_city` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. `Vector_store` - –ø–æ–∏—Å–∫ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π (–ü–ï–†–í–´–ô –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!)
4. `Research` - Perplexity –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ Vector_store)
5. `Structured Output Parser` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞

**–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É:**
- 40-45 –ª–µ—Ç: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º (–ø–µ—Ä–∏–º–µ–Ω–æ–ø–∞—É–∑–∞)
- 46-50 –ª–µ—Ç: –ø–µ—Ä–∏–º–µ–Ω–æ–ø–∞—É–∑–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–º–ø—Ç–æ–º–∞–º–∏
- 51+ –ª–µ—Ç: –º–µ–Ω–æ–ø–∞—É–∑–∞ –∏ –ø–æ—Å—Ç–º–µ–Ω–æ–ø–∞—É–∑–∞

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:**
```
ü§ó –°–ø–∞—Å–∏–±–æ –∑–∞ –¥–æ–≤–µ—Ä–∏–µ!

üìã –ü—Ä–æ—Å—Ç–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
üë©‚Äç‚öïÔ∏è –°–∏–º–ø—Ç–æ–º—ã
üî¨ –ß—Ç–æ –∏–∑–≤–µ—Å—Ç–Ω–æ –Ω–∞—É–∫–µ
üîç –ü—Ä–∏—á–∏–Ω—ã –∏ —Ñ–∞–∫—Ç–æ—Ä—ã
‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
üí° –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã
üè• –ö–æ–≥–¥–∞ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –≤—Ä–∞—á—É
‚ú® –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã
üìö –ö–∞–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –∑–∞–¥–∞—Ç—å –≤—Ä–∞—á—É

‚ö†Ô∏è –î–∏—Å–∫–ª–µ–π–º–µ—Ä
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –ú–∞–∫—Å–∏–º—É–º 4000 —Å–∏–º–≤–æ–ª–æ–≤
- –ù–ï –¥–∞–≤–∞—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π
- –ù–ï –Ω–∞–∑—ã–≤–∞—Ç—å –ª–µ–∫–∞—Ä—Å—Ç–≤–∞
- –ù–ï –ø—Ä–æ—Å–∏—Ç—å –∑–∞–≥—Ä—É–∂–∞—Ç—å –∞–Ω–∞–ª–∏–∑—ã

### **AI Agent1** (–ø–æ–∏—Å–∫ –≤—Ä–∞—á–µ–π)

**–†–æ–ª—å:** –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤—Ä–∞—á–µ–π

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
1. `search_doctors(query, filter)` - –ø–æ–∏—Å–∫ –≤ –ë–î –≤—Ä–∞—á–µ–π
2. `research` - –ø–æ–∏—Å–∫ –≤—Ä–∞—á–µ–π –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ (–ü—Ä–æ–î–æ–∫—Ç–æ—Ä–æ–≤, DocDoc –∏ —Ç.–¥.)

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- `specialists_query` - —Å–ø–∏—Å–æ–∫ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π
- `city` - –≥–æ—Ä–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `query_text` - –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `response_text` - –æ—Ç–≤–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–≥–µ–Ω—Ç–∞

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ü–æ–∏—Å–∫ –≤ –ë–î: `search_doctors(query=specialists_query, filter={city})`
2. –ï—Å–ª–∏ –Ω–µ –≤—Å–µ –Ω–∞–π–¥–µ–Ω—ã ‚Üí research –¥–ª—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö
3. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
4. –í—ã–≤–µ—Å—Ç–∏ —Å–ø–∏—Å–æ–∫ —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º:**
- –†–§: –ü—Ä–æ–î–æ–∫—Ç–æ—Ä–æ–≤, DocDoc, –ù–∞–ü–æ–ø—Ä–∞–≤–∫—É
- –°–ù–ì: 103.by, Kdoctor.kz, med.uz
- –ï–≤—Ä–æ–ø–∞: Jameda, Doctolib, Znanylekarz.pl

---

## ‚úÖ –ß—Ç–æ —É–∂–µ –µ—Å—Ç—å –≤ –∫–æ–¥–µ

### 1. **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**
- ‚úÖ `lib/telegram/bot.ts` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ `lib/telegram/webhook-handler.ts` - –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
- ‚úÖ `lib/telegram/commands.ts` - –∫–æ–º–∞–Ω–¥—ã (/start, /export, /delete, /history)
- ‚úÖ `lib/telegram/message-handler.ts` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ `app/api/telegram/webhook/route.ts` - webhook endpoint

### 2. **AI –æ–±—Ä–∞–±–æ—Ç–∫–∞**
- ‚úÖ `lib/ai/message-processor.ts` - –µ–¥–∏–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
- ‚úÖ `lib/ai/main-agent.ts` - –æ—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç (AI Agent)
- ‚úÖ `lib/ai/agent.ts` - –∞–≥–µ–Ω—Ç –ø–æ–∏—Å–∫–∞ –≤—Ä–∞—á–µ–π (AI Agent1)
- ‚úÖ `lib/ai/claude.ts` - Claude integration
- ‚úÖ `lib/ai/lakera.ts` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ `lib/ai/rag.ts` - Vector Store

---

## ‚ùå –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å

### 1. **–ö—Ä–∏—Ç–∏—á–Ω–æ**

#### `lib/telegram/callbacks.ts` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫

```typescript
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:
- handleConsentAgree() - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞–ø—Ä–æ—Å –≤–æ–∑—Ä–∞—Å—Ç–∞
- handleConsentDecline() - –æ—Ç–∫–∞–∑ –æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- handleAgeSelection() - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ (40-45, 46-50, 50+)
- handleFreeTopicSelection() - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Ç–µ–º
- handleDoctorThanks() - —Å–ø–∞—Å–∏–±–æ –ø–æ—Å–ª–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤—Ä–∞—á–∞
- handlePaymentInfo() - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ
- handleSelectAnotherTopic() - –≤—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å
- handleThankYou() - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
- handleListenPodcast() - —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–∫–∞—Å—Ç
```

#### –£–ª—É—á—à–∏—Ç—å `commands.ts`
- ‚úÖ `/start` —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ, –Ω–æ –ù–ï —Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚ùå –ù—É–∂–Ω–æ: –ø—Ä–∏ `consent_agree` —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ `menohub_users`

### 2. **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤**

#### `lib/ai/tools/get-user-age.ts`
```typescript
// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ menohub_users
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç age_range: '40-45' | '46-50' | '50+' | null
```

#### `lib/ai/tools/update-city.ts`
```typescript
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –≤ menohub_users
// –ü—Ä–∏–Ω–∏–º–∞–µ—Ç: userId, city
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: success
```

#### `lib/ai/tools/search-doctors.ts`
```typescript
// –ü–æ–∏—Å–∫ –≤—Ä–∞—á–µ–π –≤ –ë–î (menohub_experts)
// –ü—Ä–∏–Ω–∏–º–∞–µ—Ç: query (—Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏), filter (city)
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: —Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏
```

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –∞–≥–µ–Ω—Ç—ã
- ‚ùå –î–æ–±–∞–≤–∏—Ç—å `Get_user_age` –≤ `main-agent-tools.ts`
- ‚ùå –î–æ–±–∞–≤–∏—Ç—å `Update_city` –≤ `main-agent-tools.ts`
- ‚ùå –î–æ–±–∞–≤–∏—Ç—å `search_doctors` –≤ `agent-tools.ts`

### 3. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥**

#### Flow —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:
1. `/start` ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
2. `consent_agree` ‚Üí
   - –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ `menohub_users`
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å –æ –≤–æ–∑—Ä–∞—Å—Ç–µ (–∫–Ω–æ–ø–∫–∏: 40-45, 46-50, 50+)
3. –í—ã–±–æ—Ä –≤–æ–∑—Ä–∞—Å—Ç–∞ ‚Üí
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å `age_range` –≤ –ë–î
   - –ü–æ–∫–∞–∑–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ç–µ–º—ã (–ø—Ä–∏–ª–∏–≤—ã, —Å–æ–Ω, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –≤–µ—Å)
4. –í—ã–±–æ—Ä —Ç–µ–º—ã ‚Üí
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ —Ç–µ–º–µ
   - –ö–Ω–æ–ø–∫–∏: "–ó–∞–¥–∞—Ç—å –µ—â–µ –≤–æ–ø—Ä–æ—Å" –∏–ª–∏ "–í—Å—ë –ø–æ–Ω—è—Ç–Ω–æ"

---

## üîß –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞—Ç—å callbacks.ts (2-3 —á–∞—Å–∞)

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `lib/telegram/callbacks.ts`
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—Å–µ—Ö 13 callback_data
3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –ë–î (Supabase)

### –≠—Ç–∞–ø 2: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤ –∞–≥–µ–Ω—Ç—ã (1-2 —á–∞—Å–∞)

1. –°–æ–∑–¥–∞—Ç—å `lib/ai/tools/get-user-age.ts`
2. –°–æ–∑–¥–∞—Ç—å `lib/ai/tools/update-city.ts`
3. –°–æ–∑–¥–∞—Ç—å `lib/ai/tools/search-doctors.ts`
4. –î–æ–±–∞–≤–∏—Ç—å –≤ `main-agent-tools.ts` –∏ `agent-tools.ts`

### –≠—Ç–∞–ø 3: –£–ª—É—á—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é (1 —á–∞—Å)

1. –û–±–Ω–æ–≤–∏—Ç—å `/start` –≤ `commands.ts`
2. –î–æ–±–∞–≤–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ `consent_agree`
3. –î–æ–±–∞–≤–∏—Ç—å flow –≤—ã–±–æ—Ä–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞

### –≠—Ç–∞–ø 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (1 —á–∞—Å)

1. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ ngrok
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤

### –≠—Ç–∞–ø 5: –î–µ–ø–ª–æ–π (30 –º–∏–Ω)

1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –Ω–∞ Vercel
2. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å webhook —Å n8n –Ω–∞ –Ω–æ–≤—ã–π URL
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–µ—Ä–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–û–±—â–µ–µ –≤—Ä–µ–º—è: 5-7 —á–∞—Å–æ–≤**

---

## üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook

### –í n8n (—Å—Ç–∞—Ä—ã–π)
```
Webhook URL: https://n8n-server.com/webhook/...
```

### –í –Ω–æ–≤–æ–º –∫–æ–¥–µ (Vercel)
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook
curl -X POST "https://api.telegram.org/bot<BOT_TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app/api/telegram/webhook",
    "secret_token": "–≤–∞—à-—Å–µ–∫—Ä–µ—Ç–Ω—ã–π-—Ç–æ–∫–µ–Ω"
  }'

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook
curl "https://api.telegram.org/bot<BOT_TOKEN>/getWebhookInfo"
```

### Environment Variables

```bash
# Telegram
TELEGRAM_BOT_TOKEN=xxx
TELEGRAM_WEBHOOK_SECRET=xxx

# Supabase
NEXT_PUBLIC_SUPABASE_URL=xxx
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx

# AI
ANTHROPIC_API_KEY=xxx
LAKERA_API_KEY=xxx
PERPLEXITY_API_KEY=xxx
```

---

## üìù –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ (ngrok)

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å dev server
npm run dev

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å ngrok
ngrok http 3000

# 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook –Ω–∞ ngrok URL
curl -X POST "https://api.telegram.org/bot<BOT_TOKEN>/setWebhook" \
  -d "url=https://xxx.ngrok-free.app/api/telegram/webhook"

# 4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ Telegram
```

### –ß–µ–∫-–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

- [ ] /start ‚Üí –°–æ–≥–ª–∞—Å–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
- [ ] –ù–∞–∂–∞—Ç—å "–°–æ–≥–ª–∞—Å–µ–Ω" ‚Üí –í—ã–±–æ—Ä –≤–æ–∑—Ä–∞—Å—Ç–∞
- [ ] –í—ã–±—Ä–∞—Ç—å –≤–æ–∑—Ä–∞—Å—Ç ‚Üí –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ç–µ–º—ã
- [ ] –í—ã–±—Ä–∞—Ç—å —Ç–µ–º—É ‚Üí –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç —Å –∫–Ω–æ–ø–∫–∞–º–∏
- [ ] –ó–∞–¥–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å ‚Üí –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI Agent
- [ ] –ü–æ–ø—Ä–æ—Å–∏—Ç—å –Ω–∞–π—Ç–∏ –≤—Ä–∞—á–∞ ‚Üí –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π
- [ ] /export_my_data ‚Üí –ü–æ–ª—É—á–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç
- [ ] /history ‚Üí –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
- [ ] /delete_my_data ‚Üí –£–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **Webhook Secret** - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `TELEGRAM_WEBHOOK_SECRET` –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤ endpoint
2. **Rate Limiting** - –¥–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ (Upstash Redis)
3. **Lakera Guard** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ prompt injection
4. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** - –ø—Ä–æ–≤–µ—Ä—è—Ç—å callback_data –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
- –û—à–∏–±–∫–∏ webhook (–ª–æ–≥–∏ Vercel)
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ AI –∞–≥–µ–Ω—Ç–æ–≤
- –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π

---

## ‚ùì –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è

1. **–ü–ª–∞—Ç–µ–∂–∏**: –ë—É–¥–µ—Ç –ª–∏ –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Telegram Payments –∏–ª–∏ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å–∞–π—Ç (–ÆKassa)?
2. **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ç–µ–º—ã**: –ù—É–∂–Ω—ã –ª–∏ –ø—Ä–µ–¥–∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø–æ —Ç–µ–º–∞–º (–ø—Ä–∏–ª–∏–≤—ã, —Å–æ–Ω –∏ —Ç.–¥.) –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ AI Agent?
3. **–ü–æ–¥–∫–∞—Å—Ç**: –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–∫–∞—Å—Ç - —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–ª–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∏–∑ –ë–î?
4. **–í—Ç–æ—Ä–æ–π –∞–≥–µ–Ω—Ç**: AI Agent1 —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ `lib/ai/agent.ts` - –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏—Ç—å tool `search_doctors`?
