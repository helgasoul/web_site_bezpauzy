# Настройка отправки email для рассылки

## Проблема
Данные сохраняются в Supabase, но email уведомления не приходят.

## Решение

### 1. Установка и настройка Resend

Resend уже установлен в проекте (`package.json`). Нужно настроить API ключ.

### 2. Получение API ключа Resend

1. Зарегистрируйтесь на [resend.com](https://resend.com)
2. Перейдите в Settings → API Keys
3. Создайте новый API ключ
4. Скопируйте ключ

### 3. Настройка переменных окружения

Добавьте в `.env.local`:

```env
# Resend API Key для отправки email
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxx

# Email отправителя (должен быть верифицирован в Resend)
RESEND_FROM_EMAIL=Без |Паузы <noreply@bezpauzy.com>

# URL сайта (для ссылок в email)
NEXT_PUBLIC_SITE_URL=https://bezpauzy.com
```

**Важно:**
- Email в `RESEND_FROM_EMAIL` должен быть верифицирован в Resend
- Для разработки можно использовать `onboarding@resend.dev` (тестовый домен)
- Для продакшена нужно добавить свой домен в Resend

### 4. Верификация домена в Resend

1. Перейдите в Resend Dashboard → Domains
2. Добавьте свой домен (например, `bezpauzy.com`)
3. Добавьте DNS записи, которые покажет Resend
4. Дождитесь верификации (обычно несколько минут)

### 5. Применение миграции базы данных

Выполните миграцию для добавления поля `unsubscribe_token`:

```sql
-- В Supabase Dashboard → SQL Editor
-- Выполните содержимое файла:
-- supabase/migrations/024_add_unsubscribe_token_to_newsletter.sql
```

Или через CLI:
```bash
supabase migration up
```

### 6. Проверка работы

1. Перезапустите dev сервер:
```bash
npm run dev
```

2. Попробуйте подписаться на рассылку
3. Проверьте почту (включая спам)
4. Проверьте логи в консоли сервера

### 7. Отладка

Если email не приходит:

1. **Проверьте переменные окружения:**
   ```bash
   # В терминале проекта
   echo $RESEND_API_KEY
   ```

2. **Проверьте логи сервера:**
   - В консоли Next.js должны быть сообщения об отправке email
   - Если есть ошибки, они будут в логах

3. **Проверьте Resend Dashboard:**
   - Перейдите в Resend Dashboard → Emails
   - Там должны быть логи всех отправленных писем
   - Если письмо не отправлено, будет видна причина

4. **Проверьте спам:**
   - Email может попасть в спам
   - Проверьте папку "Спам" в почтовом ящике

### 8. Альтернативные email сервисы

Если Resend не подходит, можно использовать:

- **SendGrid** - популярный сервис, хорошая доставляемость
- **Mailgun** - надежный сервис для транзакционных email
- **Amazon SES** - дешевый вариант для больших объемов
- **Supabase Edge Functions** - можно использовать встроенные функции Supabase

### 9. Что уже реализовано

✅ Функция отправки email (`lib/email/send-newsletter-confirmation.ts`)
✅ Интеграция в API route (`app/api/newsletter/subscribe/route.ts`)
✅ Красивый HTML шаблон письма
✅ Текстовая версия письма
✅ Ссылка для отписки
✅ Обработка ошибок
✅ Логирование в dev режиме

### 10. Следующие шаги

- [ ] Настроить `RESEND_API_KEY` в `.env.local`
- [ ] Настроить `RESEND_FROM_EMAIL` (верифицированный email)
- [ ] Применить миграцию `024_add_unsubscribe_token_to_newsletter.sql`
- [ ] Протестировать отправку email
- [ ] Создать страницу отписки (`/newsletter/unsubscribe`)
- [ ] Создать страницу благодарности (`/newsletter/thank-you`)

## Примечания

- В dev режиме, если `RESEND_API_KEY` не настроен, email не отправляется, но подписка создается
- Это позволяет тестировать функциональность без настройки email сервиса
- В production обязательно настройте `RESEND_API_KEY`

