# Анализ Bundle Size

## Быстрая проверка

### Способ 1: Простая проверка (рекомендуется)

```bash
npm run perf:check
```

Этот скрипт:
- Проверяет размер JavaScript chunks
- Показывает предупреждения, если chunk > 250KB
- Анализирует CSS файлы
- Показывает размеры страниц

### Способ 2: Детальный анализ

```bash
npm run build
```

После сборки Next.js покажет размеры bundle в консоли. Ищите строки вида:

```
Route (app)                              Size     First Load JS
┌ ○ /                                    5.2 kB         85.3 kB
├ ○ /blog                                8.1 kB         88.2 kB
└ ○ /blog/[slug]                         12.4 kB        92.5 kB
```

### Способ 3: Визуальный анализ (Bundle Analyzer) ✅

**Уже установлено и настроено!**

Запустите анализ:

```bash
npm run perf:bundle
```

Или напрямую:

```bash
ANALYZE=true npm run build
```

После завершения сборки автоматически откроется браузер с интерактивной визуализацией bundle size. Вы увидите:
- Размер каждого модуля
- Дерево зависимостей
- Какие библиотеки занимают больше всего места
- Интерактивную карту bundle

## Целевые показатели

| Тип файла | Цель | Критично |
|-----------|------|----------|
| **JavaScript chunk** | < 250KB | < 500KB |
| **First Load JS** | < 100KB | < 200KB |
| **CSS** | < 50KB | < 100KB |
| **Общий размер страницы** | < 1MB | < 2MB |

## Что делать, если bundle слишком большой

### 1. Используйте Dynamic Imports

**Проблема:**
```tsx
import HeavyComponent from '@/components/HeavyComponent'
```

**Решение:**
```tsx
import dynamic from 'next/dynamic'

const HeavyComponent = dynamic(() => import('@/components/HeavyComponent'), {
  loading: () => <p>Загрузка...</p>,
  ssr: false, // Если не нужен для SSR
})
```

### 2. Оптимизируйте импорты библиотек

**Проблема:**
```tsx
import _ from 'lodash' // Импортирует всю библиотеку
```

**Решение:**
```tsx
import debounce from 'lodash/debounce' // Импортирует только нужную функцию
```

### 3. Используйте Tree Shaking

Убедитесь, что библиотеки поддерживают tree shaking:
- Используйте ES modules (`import` вместо `require`)
- Проверьте, что библиотека экспортирует named exports

### 4. Разделите код по страницам

Next.js автоматически делает code splitting по страницам, но вы можете оптимизировать:
- Используйте Server Components где возможно
- Lazy load компоненты ниже fold

### 5. Оптимизируйте зависимости

Проверьте, какие библиотеки занимают больше всего места:

```bash
npm run build | grep -A 20 "First Load JS"
```

Рассмотрите альтернативы для больших библиотек:
- `framer-motion` → можно использовать только для анимаций выше fold
- `@react-pdf/renderer` → загружать только на страницах, где нужен PDF
- `mammoth` → загружать только при необходимости

## Анализ текущего проекта

### Большие зависимости

Проверьте размеры этих библиотек:

1. **framer-motion** (~50KB gzipped)
   - Используется для анимаций
   - Можно lazy load для компонентов ниже fold

2. **@react-pdf/renderer** (~200KB+)
   - Используется только для генерации PDF
   - Должен быть в отдельном chunk

3. **@supabase/supabase-js** (~100KB)
   - Критическая зависимость
   - Уже оптимизирована через transpilePackages

4. **lucide-react** (~50KB+)
   - Иконки
   - Next.js автоматически tree-shake неиспользуемые иконки

### Рекомендации

1. **Проверьте использование framer-motion:**
   ```bash
   grep -r "framer-motion" components/ | wc -l
   ```
   Если используется только в нескольких компонентах, рассмотрите dynamic imports.

2. **Проверьте PDF библиотеки:**
   Убедитесь, что `@react-pdf/renderer` и `jspdf` загружаются только на страницах, где нужны.

3. **Оптимизируйте изображения:**
   Убедитесь, что все изображения в `/public` оптимизированы.

## Регулярная проверка

Рекомендуется проверять bundle size:
- После добавления новых зависимостей
- Перед каждым релизом
- Ежемесячно для мониторинга роста

## Инструменты

1. **Next.js Build Output** - встроенный анализ
2. **@next/bundle-analyzer** - визуальный анализ
3. **webpack-bundle-analyzer** - альтернатива
4. **Source Map Explorer** - детальный анализ

## Чек-лист оптимизации

- [ ] Все chunks < 250KB
- [ ] First Load JS < 100KB
- [ ] CSS < 50KB
- [ ] Большие библиотеки используют dynamic imports
- [ ] Неиспользуемый код удален
- [ ] Tree shaking работает корректно
- [ ] Изображения оптимизированы
- [ ] Шрифты оптимизированы (subset, preload)

