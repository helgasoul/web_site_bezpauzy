# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞

–£ –≤–∞—Å –µ—Å—Ç—å **–¥–≤–µ –∑–∞–ø–∏—Å–∏** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ **–æ–¥–Ω–æ–º—É –∏ —Ç–æ–º—É –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é**:

1. **id: 110** - `telegram_id: 374683580` (—Å–æ–∑–¥–∞–Ω–∞ –ø—Ä–∏ —Å–æ–≥–ª–∞—Å–∏–∏ –≤ –±–æ—Ç–µ)
2. **id: 111** - `telegram_id: 0`, `website_user_id: 111` (—Å–æ–∑–¥–∞–Ω–∞ –Ω–∞ —Å–∞–π—Ç–µ)

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ–±–Ω–æ–≤–∏—Ç—å id: 111 —Å `telegram_id: 374683580` –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ —É–∂–µ –∑–∞–Ω—è—Ç–æ –∑–∞–ø–∏—Å—å—é id: 110.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å

–ü–æ—Å–∫–æ–ª—å–∫—É –æ–±–µ –∑–∞–ø–∏—Å–∏ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –≤–∞–º, –Ω—É–∂–Ω–æ **–æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å id: 110** (–∫–æ—Ç–æ—Ä–∞—è —É–∂–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `telegram_id`), –∞ –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç.

### –í–∞—Ä–∏–∞–Ω—Ç 1: –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ò–∑–º–µ–Ω–∏—Ç–µ —É–∑–µ–ª "Update user telegram_id"**:

**–í–º–µ—Å—Ç–æ**:
```
Filter: id = {{ $('Get link code from DB').item.json.website_user_id }}
```

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ**:
```
Filter: telegram_id = {{ $json.from.id }}
```

**–õ–æ–≥–∏–∫–∞**:
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º `telegram_id` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (id: 110) ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `consent_granted = true`
- –û–±–Ω–æ–≤–∏—Ç—å `last_activity_at`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —É–∑–ª–∞ "Update user telegram_id"**:
- **Table**: `menohub_users`
- **Operation**: Update
- **Filter**:
  ```
  Field: telegram_id
  Condition: Equals
  Value: {{ $json.from.id }}
  ```
- **Fields to Update**:
  ```
  consent_granted: true
  last_activity_at: {{ $now }}
  ```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: `telegram_id` —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –µ–≥–æ –Ω–µ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å

**–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º**:

**–®–∞–≥ 1: –£–∑–µ–ª "Check if user exists with telegram_id"**

- **Table**: `menohub_users`
- **Filter**: `telegram_id = {{ $json.from.id }}`
- **Return Empty Results**: `on`

**–®–∞–≥ 2: IF —É–∑–µ–ª "User exists?"**

- **Condition**: `{{ $json.id }}` Exists
- **True** ‚Üí "Update existing user" (–æ–±–Ω–æ–≤–∏—Ç—å id: 110)
- **False** ‚Üí "Update user by website_user_id" (–æ–±–Ω–æ–≤–∏—Ç—å id: 111)

**–®–∞–≥ 3: –£–∑–µ–ª "Update existing user"**

- **Filter**: `id = {{ $json.id }}` (ID –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç.–µ. 110)
- **Fields**:
  ```
  consent_granted: true
  last_activity_at: {{ $now }}
  ```

## üîÑ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π flow

```
1. Extract link code
   ‚Üí –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–¥ –∏ telegram_id = 374683580
   ‚Üì
2. Get link code from DB
   ‚Üí –ü–æ–ª—É—á–∞–µ—Ç website_user_id = 111
   ‚Üì
3. Update code with telegram_id
   ‚Üí –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–¥ –≤ –±–∞–∑–µ
   ‚Üì
4. Check if user exists with telegram_id
   ‚Üí –ò—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å telegram_id = 374683580
   ‚Üí –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è id = 110 ‚úÖ
   ‚Üì
5. Update existing user
   ‚Üí –û–±–Ω–æ–≤–ª—è–µ—Ç id = 110
   ‚Üí –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç consent_granted = true
   ‚Üí –û–±–Ω–æ–≤–ª—è–µ—Ç last_activity_at
   ‚úÖ –ì–æ—Ç–æ–≤–æ! –ó–∞–ø–∏—Å—å id: 110 –æ–±–Ω–æ–≤–ª–µ–Ω–∞
```

## üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç id: 111:

```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º!
SELECT * FROM menohub_users WHERE id = 111;

-- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –≤ id: 110
SELECT * FROM menohub_users WHERE id = 110;

-- –ï—Å–ª–∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ id: 110, –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç
DELETE FROM menohub_users WHERE id = 111;
```

**–í–ù–ò–ú–ê–ù–ò–ï**: –ü–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:
- –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–≤–∏–∑–æ–≤ —Å–≤—è–∑–∞–Ω—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ id: 111 –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ id: 110 (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

## üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ü–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –¥—É–±–ª–∏–∫–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–≤–∏–∑–æ–≤
SELECT * FROM menohub_quiz_results WHERE user_id = 111;
SELECT * FROM menohub_quiz_results WHERE user_id = 110;

-- –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–≤—è–∑–∞–Ω—ã —Å id: 111, –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å:
UPDATE menohub_quiz_results 
SET user_id = 110 
WHERE user_id = 111;
```

## ‚úÖ –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –í–∞—Ä–∏–∞–Ω—Ç 1** (—Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π):

1. ‚úÖ –ò–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä –≤ —É–∑–ª–µ "Update user telegram_id" –Ω–∞ `telegram_id = {{ $json.from.id }}`
2. ‚úÖ –≠—Ç–æ –æ–±–Ω–æ–≤–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å id: 110
3. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `consent_granted = true`
4. ‚úÖ –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç id: 111

–≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –æ—à–∏–±–∫—É –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç –≤–∞—à—É –∑–∞–ø–∏—Å—å.

