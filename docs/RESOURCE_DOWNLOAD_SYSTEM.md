# Система скачивания гайдов

## Обзор

Система поддерживает два типа гайдов:
- **Бесплатные** - неограниченное количество скачиваний, прямое скачивание без токенов
- **Платные** - одноразовая ссылка для скачивания (1 раз), через токен

## Архитектура

### Бесплатные гайды

**Хранение:** `public/guides/` (статические файлы)

**Endpoint:** `GET /api/resources/[slug]/download`

**Особенности:**
- Прямое скачивание без токенов
- Неограниченное количество скачиваний
- Файлы доступны напрямую из файловой системы
- Счетчик скачиваний обновляется для аналитики

**Пример использования:**
```typescript
// В компоненте
<DownloadResourceButton 
  resource={freeResource} 
  label="Скачать гайд" 
/>
```

### Платные гайды

**Хранение:** Supabase Storage bucket `epub-files/`

**Процесс:**
1. Пользователь покупает гайд через `/api/resources/[slug]/purchase`
2. Создается запись в `menohub_resource_purchases` с уникальным токеном
3. После оплаты пользователь получает ссылку: `/api/resources/download/[token]`
4. Скачивание возможно только **1 раз** (max_downloads = 1)
5. Токен действителен 30 дней

**Endpoint для скачивания:** `GET /api/resources/download/[token]`

**Особенности:**
- Одноразовая ссылка (после скачивания токен становится недействительным)
- Персонализация EPUB с watermark (email, имя, дата покупки)
- Защита от повторного скачивания через счетчик

## База данных

### Таблица `menohub_resources`

```sql
- is_paid BOOLEAN -- Является ли гайд платным
- price_kopecks INTEGER -- Цена в копейках (для платных)
- epub_file_path TEXT -- Путь к EPUB файлу
- download_limit INTEGER DEFAULT 1 -- Лимит скачиваний (для платных: 1)
```

### Таблица `menohub_resource_purchases`

```sql
- download_token TEXT UNIQUE -- Уникальный токен для скачивания
- download_token_expires_at TIMESTAMPTZ -- Срок действия (30 дней)
- download_count INTEGER DEFAULT 0 -- Сколько раз скачали
- max_downloads INTEGER DEFAULT 1 -- Максимум скачиваний (1 для платных)
```

## API Endpoints

### 1. Скачивание бесплатного гайда
```
GET /api/resources/[slug]/download
```
- Проверяет, что гайд бесплатный
- Читает файл из `public/guides/`
- Возвращает файл напрямую
- Обновляет счетчик скачиваний

### 2. Скачивание платного гайда
```
GET /api/resources/download/[token]
```
- Проверяет токен и статус оплаты
- Проверяет срок действия токена (30 дней)
- Проверяет лимит скачиваний (max 1)
- Увеличивает счетчик скачиваний
- Генерирует персонализированный EPUB с watermark
- Возвращает файл

### 3. Покупка платного гайда
```
POST /api/resources/[slug]/purchase
```
- Создает заказ в `menohub_resource_purchases`
- Генерирует уникальный токен
- Создает платеж в YooKassa
- Возвращает ссылку на оплату

### 4. Проверка статуса покупки
```
GET /api/resources/[slug]/purchase-status?email=...
```
- Проверяет, куплен ли гайд
- Возвращает информацию о возможности скачивания
- Возвращает токен для скачивания (если доступно)

## Компоненты

### `DownloadResourceButton`

Универсальный компонент для скачивания гайдов:

```tsx
<DownloadResourceButton 
  resource={resource} 
  label="Скачать гайд"
  onDownloadComplete={() => console.log('Downloaded!')}
/>
```

**Логика:**
- Для бесплатных: использует `/api/resources/[slug]/download`
- Для платных: показывает сообщение о необходимости покупки

## Миграции

### `043_insert_free_epub_guides.sql`
- Добавляет бесплатные EPUB гайды
- Добавляет платные EPUB гайды с `download_limit = 1`

### `027_create_resource_purchases_table.sql`
- Создает таблицу покупок
- `max_downloads DEFAULT 1` (одноразовая ссылка)

### `028_add_paid_fields_to_resources.sql`
- Добавляет поля для платных гайдов
- `download_limit DEFAULT 1`

## Безопасность

1. **Бесплатные гайды:**
   - Проверка `is_paid = false`
   - Проверка `published = true`
   - Файлы в `public/` доступны напрямую

2. **Платные гайды:**
   - Уникальный токен для каждой покупки
   - Проверка статуса оплаты (`status = 'paid'`)
   - Проверка срока действия токена
   - Проверка лимита скачиваний (max 1)
   - Персонализация EPUB с watermark

## Примеры использования

### Бесплатный гайд
```typescript
// Пользователь нажимает "Скачать"
// → GET /api/resources/libido-expansion-menopause-guide/download
// → Файл скачивается напрямую
// → Счетчик увеличивается
```

### Платный гайд
```typescript
// 1. Пользователь нажимает "Купить за 499₽"
// → POST /api/resources/anti-aging-medicine-menopause-guide/purchase
// → Создается заказ, генерируется токен
// → Редирект на YooKassa

// 2. После оплаты
// → YooKassa webhook обновляет статус на 'paid'
// → Пользователь получает email с ссылкой: /api/resources/download/[token]

// 3. Пользователь нажимает ссылку
// → GET /api/resources/download/[token]
// → Проверка токена, статуса, лимита
// → Генерация персонализированного EPUB
// → Скачивание (1 раз)
// → download_count = 1, токен больше недействителен
```

## Важные моменты

1. **Бесплатные гайды** - неограниченное скачивание, файлы в `public/guides/`
2. **Платные гайды** - одноразовая ссылка (1 скачивание), файлы в Supabase Storage
3. **Токены** - уникальные для каждой покупки, действительны 30 дней
4. **Персонализация** - платные EPUB содержат watermark с информацией о покупателе
5. **Безопасность** - все проверки на сервере, токены нельзя подделать
