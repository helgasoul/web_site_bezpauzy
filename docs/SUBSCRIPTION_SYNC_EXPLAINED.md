# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –º–µ–∂–¥—É —Å–∞–π—Ç–æ–º –∏ Telegram

## ‚úÖ –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç: –î–ê, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è!

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—Ç–∏–ª –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —Å–∞–π—Ç–µ –∏ –ø–æ—à–µ–ª —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å —Å –±–æ—Ç–æ–º –≤ Telegram ‚Äî **–ø–æ–¥–ø–∏—Å–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π**.

---

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### **1. –ï–¥–∏–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  menohub_users      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  id                 ‚îÇ  ‚Üê –ì–ª–∞–≤–Ω—ã–π –∫–ª—é—á
‚îÇ  telegram_id        ‚îÇ  ‚Üê –°–≤—è–∑—å —Å Telegram
‚îÇ  subscription_status‚îÇ  ‚Üê –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
‚îÇ  subscription_plan  ‚îÇ  ‚Üê –¢–∞—Ä–∏—Ñ
‚îÇ  is_subscribed      ‚îÇ  ‚Üê –§–ª–∞–≥ –ø–æ–¥–ø–∏—Å–∫–∏
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üë         ‚Üë
         ‚îÇ         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ                   ‚îÇ
  –°–ê–ô–¢              TELEGRAM
```

### **2. –û–ø–ª–∞—Ç–∞ –Ω–∞ —Å–∞–π—Ç–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ë–î**

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –Ω–∞ —Å–∞–π—Ç–µ:

```typescript
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –ÆKassa
await supabase
  .from('menohub_users')
  .update({
    subscription_status: 'active',  // ‚Üê –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É
    subscription_plan: 'monthly',
    is_subscribed: true,
  })
  .eq('id', userId)
```

### **3. –ë–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏**

**–§–∞–π–ª:** `lib/telegram/message-handler.ts:45-67`

```typescript
// –ö–ê–ñ–î–´–ô –†–ê–ó –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –≤ Telegram:
const { data: user } = await supabase
  .from('menohub_users')
  .select('id, telegram_id, subscription_status')  // ‚Üê –ù–û–í–´–ô –∑–∞–ø—Ä–æ—Å –∫ –ë–î
  .eq('telegram_id', userId)
  .single()

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
if (user.subscription_status !== 'active') {
  // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
} else {
  // –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω ‚úÖ
}
```

**–ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç:** –ë–æ—Ç **–ù–ï –∫–µ—à–∏—Ä—É–µ—Ç** —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏. –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ = –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î = –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å!

---

## üìä –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è

### **–®–∞–≥ 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Telegram**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /start –≤ Telegram
   ‚Üì
–°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ –ë–î:
- telegram_id: 123456789
- subscription_status: NULL (–Ω–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏)
- is_subscribed: false
```

### **–®–∞–≥ 2: –ü–æ–ø—ã—Ç–∫–∞ –ø–∏—Å–∞—Ç—å –±–æ—Ç—É**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
   ‚Üì
–ë–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ë–î: subscription_status !== 'active'
   ‚Üì
‚ùå "–î–ª—è –æ–±—â–µ–Ω–∏—è —Å –ï–≤–æ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞"
```

### **–®–∞–≥ 3: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–∞–π—Ç**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –Ω–∞–∂–∏–º–∞–µ—Ç "üåê –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç"
   ‚Üì
–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è: https://bez-pauzy.ru?tg_id=123456789
   ‚Üì
–°–∞–π—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Ö–æ–¥–∏—Ç (–ø–æ telegram_id)
```

### **–®–∞–≥ 4: –û–ø–ª–∞—Ç–∞ –Ω–∞ —Å–∞–π—Ç–µ**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –æ—Ñ–æ—Ä–º–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ /pricing
   ‚Üì
–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –ÆKassa
   ‚Üì
Webhook –æ—Ç –ÆKassa ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î:
- subscription_status: 'active'  ‚Üê –û–ë–ù–û–í–õ–ï–ù–û
- subscription_plan: 'monthly'
- is_subscribed: true
```

### **–®–∞–≥ 5: –í–æ–∑–≤—Ä–∞—Ç –≤ Telegram**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
   ‚Üì
–ë–æ—Ç –¥–µ–ª–∞–µ—Ç –ù–û–í–´–ô –∑–∞–ø—Ä–æ—Å –∫ –ë–î
   ‚Üì
–ü–æ–ª—É—á–∞–µ—Ç: subscription_status = 'active'
   ‚Üì
‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è! –ü–æ–¥–ø–∏—Å–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç!
```

---

## ‚è±Ô∏è –°–∫–æ—Ä–æ—Å—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

| –î–µ–π—Å—Ç–≤–∏–µ | –í—Ä–µ–º—è |
|----------|-------|
| –û–ø–ª–∞—Ç–∞ –Ω–∞ —Å–∞–π—Ç–µ ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î | ~1-3 —Å–µ–∫—É–Ω–¥—ã |
| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î ‚Üí –¥–æ—Å—Ç—É–ø–Ω–æ –≤ Telegram | **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ** |
| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç ‚Üí –±–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ë–î | –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ |

**–ò—Ç–æ–≥–æ:** –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ **—Å—Ä–∞–∑—É** –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏!

---

## üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–æ–Ω—É—Å:** –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ —Ç–æ–∂–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –≤ Telegram ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å source='telegram'
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –Ω–∞ —Å–∞–π—Ç–µ ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å source='website'
   ‚Üì
–û–±–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ menohub_queries
   ‚Üì
–í–∏–¥–Ω—ã –∏ –≤ Telegram (/history), –∏ –Ω–∞ —Å–∞–π—Ç–µ (—á–∞—Ç)
```

---

## üéØ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### **SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**

```sql
SELECT
  telegram_id,
  subscription_status,
  subscription_plan,
  is_subscribed,
  updated_at
FROM menohub_users
WHERE telegram_id = 123456789; -- –≤–∞—à telegram_id
```

### **–¢–µ—Å—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:**

1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Table Editor
2. –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ `telegram_id`
3. –ò–∑–º–µ–Ω–∏—Ç–µ `subscription_status` –Ω–∞ `'active'`
4. –ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É –≤ Telegram
5. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç —Å—Ä–∞–∑—É —Ä–∞–∑—Ä–µ—à–∏—Ç –¥–æ—Å—Ç—É–ø!

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### **1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –≤–µ–∑–¥–µ:**

**–í Telegram:**
```typescript
if (user.subscription_status !== 'active') {
  // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
}
```

**–ù–∞ —Å–∞–π—Ç–µ:**
```typescript
if (user.subscription_status !== 'active') {
  // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
}
```

### **2. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ù–ï–¢:**

- ‚ùå –ë–î –Ω–µ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –±–æ—Ç–∞
- ‚ùå –°—Ç–∞—Ç—É—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Å–µ—Å—Å–∏–∏
- ‚úÖ –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å = —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î

### **3. –°–≤—è–∑—å —á–µ—Ä–µ–∑ telegram_id:**

–û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç—Å—è –ø–æ `telegram_id` –∏ –≤ –±–æ—Ç–µ, –∏ –Ω–∞ —Å–∞–π—Ç–µ (—á–µ—Ä–µ–∑ deep link `?tg_id=...`)

---

## üéâ –ò—Ç–æ–≥–æ

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—Ç–∏–ª –Ω–∞ —Å–∞–π—Ç–µ ‚Üí –±–æ—Ç —Å—Ä–∞–∑—É –≤–∏–¥–∏—Ç –ø–æ–¥–ø–∏—Å–∫—É!**

–ù–∏–∫–∞–∫–∏—Ö:
- ‚ùå –†—É—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- ‚ùå –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ –±–æ—Ç–∞
- ‚ùå –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
- ‚ùå –ó–∞–¥–µ—Ä–∂–µ–∫

–í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ** –±–ª–∞–≥–æ–¥–∞—Ä—è:
1. –ï–¥–∏–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
2. –ó–∞–ø—Ä–æ—Å—É –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
3. –°–≤—è–∑–∏ —á–µ—Ä–µ–∑ `telegram_id`

---

## üìù –§–∞–π–ª—ã –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏

- `lib/telegram/message-handler.ts:47` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ Telegram
- `app/api/chat/send-message/route.ts:76-93` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–∞–π—Ç–µ
- `app/api/auth/telegram/link-from-bot/route.ts:34-38` - –∞–≤—Ç–æ–≤—Ö–æ–¥ —Å —Å–∞–π—Ç–∞ –ø–æ telegram_id
- `lib/telegram/callbacks.ts:251-270` - –∫–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç"
