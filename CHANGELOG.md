# Changelog

Все значимые изменения в проекте будут документироваться в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и этот проект придерживается [Semantic Versioning](https://semver.org/lang/ru/).

## [Unreleased]

### Добавлено
- Система регистрации и входа через логин/пароль
- Привязка аккаунта к Telegram ID через deep links
- Личный кабинет пользователя с отображением данных
- API для регистрации (`/api/auth/register`)
- API для входа на сайте (`/api/auth/website/login`)
- API для генерации кодов привязки Telegram (`/api/auth/link-telegram/generate-code`)
- Компоненты: `RegisterModal`, `WebsiteLoginModal`, `TelegramLinkModal`
- Миграции базы данных для поддержки веб-авторизации
- RLS политики для таблицы `menohub_users`
- Интеграция с n8n workflow для обработки deep links из бота

### Изменено
- Обновлен `AccountDashboard` для работы с новой системой авторизации
- Обновлен `ChatAuthGate` для поддержки входа через логин/пароль
- Обновлен `AskEvaWidget` для проверки авторизации и подписки
- Упрощен процесс входа (убрана кнопка "Войти через Telegram")
- Обновлены API routes для работы с `user_id` вместо только `telegram_id`
- `AuthModal` теперь показывает только 2 опции: "Зарегистрироваться" и "Войти через логин/пароль"
- `RegisterModal` позволяет пропустить привязку Telegram при сохранении результатов квиза (`skipTelegramLink={true}`)
- `ChatAuthGate` использует `router.refresh()` для обновления страницы после входа/регистрации (вместо полной перезагрузки)

### Исправлено
- Исправлена установка cookie при входе
- Исправлен редирект в личный кабинет после входа
- Исправлена проверка сессии с повторными попытками
- Исправлена загрузка результатов квизов для пользователей без Telegram ID
- Упрощен `AuthModal` - удалена логика входа через Telegram код и Email (оставлены только регистрация и вход через логин/пароль)
- Добавлен проп `skipTelegramLink` в `RegisterModal` для опциональной привязки Telegram при сохранении результатов квиза
- Исправлен `WebsiteLoginModal` - теперь правильно вызывает `onSuccess` после успешного входа
- Унифицирована обработка успеха - используется `router.refresh()` вместо `window.location.reload()` в `ChatAuthGate`
- Улучшена проверка сессии - добавлена проверка в `RegisterModal` после регистрации (3 попытки)
- Упрощена retry логика в `WebsiteLoginModal` (3 попытки вместо 5)
- Убраны отладочные `console.log` из production кода
- Исправлен `ChatAuthGate` - теперь использует `TelegramLinkModal` вместо ссылки на `/account` для привязки Telegram
- Оптимизирована проверка сессии в `AccountDashboard` - уменьшено количество попыток с 10 до 3 для более быстрой загрузки
- Убраны все `console.log` из `AccountDashboard` и API `/api/auth/telegram/get-session` для production-ready кода
- Исправлена ссылка на несуществующую страницу `/login` в `QuizResultsHistory` - теперь редирект на главную страницу
- Исправлен двойной редирект в `RegisterModal` - теперь `router.push('/account')` выполняется только если `onSuccess` не передан
- **КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ:** Исправлена проблема с редиректом после входа - пользователь теперь корректно перенаправляется в личный кабинет вместо главной страницы
  - Увеличено количество попыток проверки сессии в `AccountDashboard` до 10 для надежности
  - Добавлена дополнительная проверка cookie перед редиректом в `AuthModal`
  - Заменено `window.location.href` на `router.push()` + `router.refresh()` для более плавного перехода
  - Увеличено количество попыток проверки сессии в `WebsiteLoginModal` до 5
  - Добавлены заголовки для предотвращения кеширования в fetch запросах и API responses
  - Улучшена обработка ошибок HTTP в проверке сессии

## [1.0.0] - 2025-01-XX

### Добавлено
- Начальная версия сайта
- Интеграция с Supabase
- Система квизов (MRS, Индекс воспаления)
- Блог с статьями
- Чат с Евой (AI-ассистент)
- Сообщество пользователей
- Личный кабинет
- Генерация PDF результатов квизов

