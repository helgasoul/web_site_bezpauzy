# Инструкция по выполнению миграции для сохранения результатов квиза

## Что такое миграция?

**Миграция** — это SQL-скрипт, который создает новую таблицу в базе данных Supabase для хранения результатов квиза.

**Без миграции:**
- ❌ Кнопка "Сохранить мои результаты" не будет работать
- ❌ API вернет ошибку при попытке сохранить результаты
- ❌ В личном кабинете не будут отображаться сохраненные результаты

**С миграцией:**
- ✅ Результаты квиза будут сохраняться в базе данных
- ✅ Пользователи смогут видеть свои результаты в личном кабинете
- ✅ Все работает как задумано

## Как выполнить миграцию?

### Вариант 1: Через Supabase Dashboard (рекомендуется)

1. **Откройте Supabase Dashboard**
   - Перейдите на [supabase.com](https://supabase.com)
   - Войдите в свой проект

2. **Откройте SQL Editor**
   - В левом меню найдите "SQL Editor"
   - Нажмите "New query"

3. **Скопируйте содержимое файла миграции**
   - Откройте файл: `supabase/migrations/003_create_quiz_results.sql`
   - Скопируйте весь текст (Ctrl+C / Cmd+C)

4. **Вставьте и выполните**
   - Вставьте скопированный SQL-код в редактор
   - Нажмите кнопку "Run" (или Ctrl+Enter / Cmd+Enter)

5. **Проверьте результат**
   - Должно появиться сообщение "Success. No rows returned"
   - Если есть ошибки — проверьте, что таблица `menohub_community_members` уже существует

### Вариант 2: Через командную строку (для продвинутых)

Если у вас установлен Supabase CLI:

```bash
supabase db push
```

Или напрямую через psql:

```bash
psql -h your-db-host -U postgres -d postgres -f supabase/migrations/003_create_quiz_results.sql
```

## Что создает эта миграция?

1. **Таблица `quiz_results`** с полями:
   - `id` — уникальный идентификатор
   - `user_id` — связь с пользователем
   - `email` — email пользователя
   - `total_score` — общий балл
   - `vasomotor_score`, `psychological_score`, `urogenital_score`, `somatic_score` — баллы по категориям
   - `severity` — степень тяжести (mild/moderate/severe)
   - `recommendations` — рекомендации (JSON)
   - `answers` — ответы пользователя (JSON)
   - `created_at`, `updated_at` — даты создания и обновления

2. **Индексы** для быстрого поиска по:
   - `user_id` — поиск результатов пользователя
   - `email` — поиск по email
   - `created_at` — сортировка по дате

3. **Безопасность (RLS)**
   - Включает Row Level Security
   - Пока разрешает все операции (можно будет ужесточить позже)

4. **Автоматическое обновление**
   - Триггер для автоматического обновления `updated_at` при изменении записи

## Проверка после миграции

После выполнения миграции проверьте:

1. **В Supabase Dashboard → Table Editor**
   - Должна появиться таблица `quiz_results`
   - Проверьте, что все поля созданы правильно

2. **Проверьте работу функционала**
   - Пройдите квиз на сайте
   - Нажмите "Сохранить мои результаты"
   - Введите email
   - Проверьте, что результаты сохранились в таблице

## Если что-то пошло не так

### Ошибка: "relation menohub_community_members does not exist"
**Решение:** Сначала выполните миграцию `001_create_community_members.sql`

### Ошибка: "table quiz_results already exists"
**Решение:** Это нормально, таблица уже создана. Можно пропустить миграцию.

### Ошибка: "permission denied"
**Решение:** Убедитесь, что используете правильные права доступа в Supabase Dashboard

## Важно!

- ✅ Выполняйте миграцию **один раз** на базе данных
- ✅ Не удаляйте таблицу после создания (иначе потеряются данные)
- ✅ Делайте бэкап базы данных перед миграцией (если есть важные данные)

## Нужна помощь?

Если возникли проблемы:
1. Проверьте логи в Supabase Dashboard → Logs
2. Убедитесь, что все предыдущие миграции выполнены
3. Проверьте, что у вас есть права на создание таблиц

