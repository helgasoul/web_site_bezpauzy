#!/bin/bash

# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –≤–µ—Ç–æ–∫ —Å backup

set -e

echo "üõ°Ô∏è  –ë–ï–ó–û–ü–ê–°–ù–û–ï –û–ë–™–ï–î–ò–ù–ï–ù–ò–ï –í–ï–¢–û–ö"
echo "================================"
echo ""

# –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å backup
echo "üì¶ –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
BACKUP_BRANCH="backup-before-merge-$(date +%Y%m%d-%H%M%S)"
git branch "$BACKUP_BRANCH" 2>/dev/null || echo "‚ö†Ô∏è  –í–µ—Ç–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é"
echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: $BACKUP_BRANCH"
echo ""

# –®–∞–≥ 2: –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å GitHub (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
echo "üîç –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ GitHub..."
git fetch origin
echo "‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞"
echo ""

# –®–∞–≥ 3: –ü–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –Ω–∞ GitHub
echo "üìã –®–∞–≥ 3: –ß—Ç–æ –Ω–∞ GitHub (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∫–æ–º–º–∏—Ç–æ–≤):"
git log origin/main --oneline -5 || echo "‚ö†Ô∏è  –ù–µ—Ç –∫–æ–º–º–∏—Ç–æ–≤ –Ω–∞ GitHub"
echo ""

# –®–∞–≥ 4: –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–ª–∏—á–∏—è
echo "üìä –®–∞–≥ 4: –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è:"
DIFF_FILES=$(git diff main origin/main --name-only 2>/dev/null || echo "")
if [ -z "$DIFF_FILES" ]; then
    echo "‚úÖ –ù–µ—Ç —Ä–∞–∑–ª–∏—á–∏–π - –≤—Å–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ"
else
    echo "$DIFF_FILES"
fi
echo ""

# –®–∞–≥ 5: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –°–µ–π—á–∞—Å –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–µ—Ç–æ–∫"
echo "üì¶ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: $BACKUP_BRANCH"
echo "üîÑ –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
echo "   git reset --hard $BACKUP_BRANCH"
echo ""
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
    exit 1
fi

# –®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é merge
echo ""
echo "‚öôÔ∏è  –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ merge..."
git config pull.rebase false
echo "‚úÖ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞"
echo ""

# –®–∞–≥ 7: –û–±—ä–µ–¥–∏–Ω–∏—Ç—å
echo "üîÑ –®–∞–≥ 6: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–µ—Ç–æ–∫..."
if git pull origin main --allow-unrelated-histories --no-edit; then
    echo "‚úÖ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!"
else
    echo ""
    echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã!"
    echo "üìù –†–µ—à–∏—Ç–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤—Ä—É—á–Ω—É—é, –∑–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
    echo "   git add ."
    echo "   git commit -m 'Merge: Resolved conflicts'"
    echo ""
    echo "üîÑ –ò–ª–∏ –æ—Ç–∫–∞—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:"
    echo "   git reset --hard $BACKUP_BRANCH"
    exit 1
fi
echo ""

# –®–∞–≥ 8: –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
echo "üìä –®–∞–≥ 7: –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:"
git status
echo ""

# –®–∞–≥ 9: –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã
echo "üìã –®–∞–≥ 8: –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã:"
git log --oneline -5
echo ""

# –®–∞–≥ 10: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
echo "‚úÖ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üîç –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:"
echo "   1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: npm run dev"
echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
echo "   3. –ï—Å–ª–∏ –≤—Å–µ –û–ö - –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞ GitHub:"
echo "      git push origin main"
echo ""
echo "üîÑ –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ—Ç–∫–∞—Ç–∏—Ç–µ:"
echo "   git reset --hard $BACKUP_BRANCH"
echo ""

